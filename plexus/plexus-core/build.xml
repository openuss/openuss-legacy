<project name="openuss :: plexus :: core :: build" default="install" basedir=".">
	<condition property="maven.executable" value="mvn.bat" else="mvn"><os family="windows" /></condition>
	
	<!-- 	In order to get this target under eclipse to work you need to define the variable
			m2_repo which points to your maven2 repository -->
	<target name="clover-view">
		<java fork="true" classname="com.cenqua.clover.reporters.jfc.Viewer">
			<arg line="-i target/clover/clover.db"/>
			<classpath path="${m2_repo}/com/cenqua/clover/clover/1.3.12/clover-1.3.12.jar"/>
		</java>
	</target>
	<target name="compile">
		<exec executable="${maven.executable}">
			<arg line="compile" />
		</exec>
	</target>
	<target name="clean">
		<exec executable="${maven.executable}">
			<arg line="clean" />
		</exec>
	</target>
	
	<target name="install">
		<exec executable="${maven.executable}">
			<arg line="install" />
		</exec>
	</target>
	<target name="install offline">
		<exec executable="${maven.executable}">
			<arg line="-o install" />
		</exec>
	</target>
	<target name="install w/o tests">
		<exec executable="${maven.executable}">
			<arg line="install -Dmaven.test.skip=true" />
		</exec>
	</target>	
	<target name="install w/o tests (offline)">
		<exec executable="${maven.executable}">
			<arg line="-o install -Dmaven.test.skip=true" />
		</exec>
	</target>	
	<target name="eclipse">
		<exec executable="${maven.executable}">
			<arg line="eclipse:clean eclipse:eclipse" />
			<arg line="-DdownloadSources=true" />
		</exec>
	</target>
	
	<target name="hibernate-schema" description="Generates database schema">
        <taskdef  name="schemaexport" classname="org.hibernate.tool.hbm2ddl.SchemaExportTask">
        	<classpath>
				<pathelement location="${m2_repo}/org/hibernate/hibernate/3.2.5.ga/hibernate-3.2.5.ga.jar"/>
				<pathelement location="${m2_repo}/commons-logging/commons-logging/1.1/commons-logging-1.1.jar"/>
				<pathelement location="${m2_repo}/commons-collections/commons-collections/3.1/commons-collections-3.1.jar"/>
				<pathelement location="${m2_repo}/dom4j/dom4j/1.6.1/dom4j-1.6.1.jar"/>
				<pathelement location="./target/classes" />
				<pathelement location="../plexus-api/target/classes" />
	        </classpath>
        </taskdef >

        <schemaexport output="target/firebird_database_schema.sql" 
        	create="true" 
        	text="true"
        	delimiter=";"
        	properties="hibernate-export-schema.properties">
			<fileset id="hibernate.mapping.files" dir="target/classes">
				<include name="**/*.hbm.xml" />
			</fileset>
        </schemaexport>
	</target>

	<taskdef name="recreateDB" classname="org.openuss.framework.tools.db.DatabaseSetupTask">
		<classpath>
			<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
			<pathelement location="${m2_repo}/ant/ant/1.6.5/ant-1.6.5.jar"/>
			<pathelement location="${m2_repo}/org/openuss/framework/framework-tools/3.1-SNAPSHOT/framework-tools-3.1-SNAPSHOT.jar" />
		</classpath>
	</taskdef>

	<target name="recreate-openuss30" depends="hibernate-schema">
		<recreateDB dbserverurl="localhost" dbserverport="3050"
				    dbname="openuss30"
				    dbuser="sysdba"
				    dbpassword="masterkey"/>
		
		<echo message="INFO: Creating database schemas..." />
		<sql driver="org.firebirdsql.jdbc.FBDriver" url="jdbc:firebirdsql:localhost:openuss30"
			userid="sysdba"
			password="masterkey"
			autocommit="true">
			<classpath>
				<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
			</classpath>
			<transaction src="target/firebird_database_schema.sql"/>
			<transaction src="src/main/data/init.sql"/>
			<transaction src="src/main/data/quartz.sql"/>
		</sql>
		<echo message="INFO: Database schemas created" />
	</target>
	
	<target name="recreate-openuss30-test" depends="hibernate-schema">
		<recreateDB dbserverurl="localhost" dbserverport="3050" dbname="openuss30-test" dbuser="sysdba" dbpassword="masterkey"/>
		
		<echo message="INFO: Creating database schemas..." />
		<sql driver="org.firebirdsql.jdbc.FBDriver" url="jdbc:firebirdsql:localhost:openuss30-test"
			userid="sysdba"
			password="masterkey"
			autocommit="true">
			<classpath>
				<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
			</classpath>
			<transaction src="target/firebird_database_schema.sql"/>
			<transaction src="src/main/data/init.sql"/>
			<transaction src="src/main/data/quartz.sql"/>
		</sql>
		<echo message="INFO: Database schemas created" />
	</target>

</project>
