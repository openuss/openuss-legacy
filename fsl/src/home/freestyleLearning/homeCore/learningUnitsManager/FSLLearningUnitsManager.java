/* Generated by Freestyle Learning Group */

package freestyleLearning.homeCore.learningUnitsManager;

import java.awt.*;
import java.awt.print.*;
import java.awt.event.*;
import java.awt.image.*;
import java.io.*;
import java.util.*;
import java.util.zip.*;
import javax.swing.*;
import javax.xml.bind.*;


/*** Jens Sieberg 02.08.2006 ***/
import freestyleLearning.homeCore.learningUnitsManager.unitmap.*;
/*** Ende Jens Sieberg ***/

import freestyleLearning.homeCore.*;
import freestyleLearning.homeCore.welcomeScreen.*;
import freestyleLearning.homeCore.programConfigurationManager.*;
import freestyleLearning.homeCore.learningUnitsManager.data.xmlBinding.*;
import freestyleLearning.homeCore.learningUnitsManager.data.xmlBindingSubclasses.*;
import freestyleLearning.homeCore.learningUnitsManager.dialogs.*;
import freestyleLearning.homeCore.learningUnitsManager.learningUnitsStructureTree.*;
import freestyleLearning.homeCore.learningUnitsManager.exceptions.*;
import freestyleLearning.homeCore.learningUnitsManager.tourCreator.*;
import freestyleLearning.homeCore.programConfigurationManager.event.*;
import freestyleLearning.homeCore.programConfigurationManager.xmlDocumentClasses.ProgramConfiguration;
import freestyleLearning.homeCore.usersManager.event.*;
import freestyleLearning.learningUnitViewAPI.*;
import freestyleLearning.learningUnitViewAPI.elementInteractionPanel.*;
import freestyleLearning.learningUnitViewAPI.events.learningUnitEvent.*;
import freestyleLearning.learningUnitViewAPI.events.learningUnitViewEvent.*;
import freestyleLearning.learningUnitViewAPI.exceptions.*;
import freestyleLearningGroup.independent.gui.*;
import freestyleLearningGroup.independent.tourCreator.*;
import freestyleLearningGroup.independent.util.*;
import freestyleLearningGroup.independent.printing.*;

public class FSLLearningUnitsManager implements FSLLearningUnitsActivator, FSLLearningUnitEventGenerator {
    private boolean editMode;
    private boolean userRoleIsAuthor;
    //private boolean userRoleIsAdministrator;
    private boolean dataChanged;
    private boolean userSelected;
    private int automaticLinksCreated = 0;
    private char[] keyHistory = new char[8];
    private File learningUnitsOriginalDataDirectory;
    private File learningUnitsUserDataDirectory;
    private FLGInternationalization internationalization;
    private FSLManagerOfManagers managerOfManagers;
    private FSLLearningUnitViewsManager learningUnitViewsManager;
    private FSLLearningUnitsNavigationHistoryManager learningUnitsNavigationHistoryManager;
    private FSLLearningUnitsDescriptor learningUnitsDescriptor;
    private FSLProgramConfigurationManager configurationManager;
    private Vector learningUnitListeners;
    private JPanel learningUnitSelectionPanel;
    private JPanel mainFrameToolBarButtonsPanel;
    private String currentUserName;
    private String currentUserPassword;
    private String currentLearningUnitId;
    private String currentLearningUnitTitle;
    private String currentLearningUnitPath;
    private java.util.List currentLearningUnitViewManagersIdList;
    private JMenu learningUnitMenu;
    private JMenuItem menuItem_edit;
    private Hashtable actions;
    private Hashtable menuItems;
    private FSLNewLearningUnitDialog newLearningUnitDialog;
    private FSLLearningUnitPropertiesDialog learningUnitPropertiesDialog;
    private FLGMainFrameToolBarButton button_print;
    private FLGMainFrameToolBarButton button_onlineLink;
    private FLGMainFrameToolBarButton button_tourCreator;
    private FSLPrintDialog printDialog;
    private FSLLearningUnitProperties learningUnitProperties;
    private Component printableComponent;
    private String printTitle;
    private String printMessage;
    private JFrame componentFrame;
    private FLGImageDialog progressDialog;
    private FSLSearchDialog searchDialog;
    private FSLCreateAutomaticLinksDialog createAutomaticLinksDialog;
    private FSLExportLearningUnitViewStructureDialog exportStructureDialog;
    private FSLTourCreator tourCreator;
    private BufferedImage bufferedImage;
    private FLGHTMLPagesCombiner htmlCombiner;
    private FLGImageProgressDialog linksCreatingProgressDialog;
    private JLabel label_selectedLearningUnit;
    private FLGEditToolBarButton learningUnitSelectionButton;
    private FSLLearningUnitsStructureTreePanel learningUnitsStructureTreePanel;
    private FSLNewLearningUnitCategoryDialog newLearningUnitCategoryDialog;
    private FSLLearningUnitCategoryPropertiesDialog learningUnitCategoryPropertiesDialog;
    private FSLWelcomeScreen welcomeScreen;
    private FSLUserEventGenerator userEventGenerator;
    private FLGImageProgressDialog exportProgressDialog;
    private FLGImageProgressDialog importProgressDialog;
    private boolean structureTreeModification = false;
    private Unitmap unitmap;
    private String[] openUSSAccountData;
    private boolean openUSSServerConnectionEstablished = false;
    
    /**
     * Inits LearningUnitsmanager.
     * The directories are defined in the configuration.xml.
     * @param <code>FSLUserEventGenerator</code> userEventGenerator
     * @param <code>FSLProgramConfigurationEventGenerator</code> configurationEventGenerator
     * @param <code>File</code> learningUnitViewManagersDirectory
     * @param <code>File</code> learningUnitsOriginalDataDirectory
     * @param <code>FLGLongLastingOperationStatus</code> progressStatus
     * @param <code>FLGImageDialog</code> progressDialog
     * @param <code>FSLManagerOfManagers</code> managerOfManagers
     **/
    public void init(FSLUserEventGenerator userEventGenerator, FSLProgramConfigurationEventGenerator configurationEventGenerator,
    		File learningUnitViewManagersDirectory, File learningUnitsOriginalDataDirectory,
    		FLGLongLastingOperationStatus progressStatus, FLGImageDialog progressDialog, FSLManagerOfManagers managerOfManagers) {
        this.managerOfManagers = managerOfManagers;
        this.userEventGenerator = userEventGenerator;
        learningUnitListeners = new Vector();
        internationalization = new FLGInternationalization("freestyleLearning.homeCore.learningUnitsManager.internationalization",
        		FSLLearningUnitsManager.class.getClassLoader());
        userEventGenerator.addUserListener(new FSLLearningUnitsManager_UserAdapter());
        configurationEventGenerator.addProgramConfigurationListener(new FSLLearningUnitsManager_ProgramConfigurationAdapter());
        configurationManager = (FSLProgramConfigurationManager)configurationEventGenerator;
        learningUnitsDescriptor = loadLearningUnitsDescriptor(new File(learningUnitsOriginalDataDirectory, "learningUnitsDescriptor.xml"));
        learningUnitViewsManager = new FSLLearningUnitViewsManager();
        this.learningUnitsOriginalDataDirectory = learningUnitsOriginalDataDirectory;
        learningUnitsNavigationHistoryManager = new FSLLearningUnitsNavigationHistoryManager();
        learningUnitViewsManager.init(this, this, learningUnitViewManagersDirectory,learningUnitsOriginalDataDirectory, learningUnitsNavigationHistoryManager,configurationEventGenerator, userEventGenerator);
        progressStatus.setStatusValue(progressStatus.getStatusValue() + (int)(progressStatus.getStepSize() / 3.));
        learningUnitsNavigationHistoryManager.init(this, learningUnitViewsManager, this);
        progressStatus.setStatusValue(progressStatus.getStatusValue() + (int)(progressStatus.getStepSize() / 3.));
        newLearningUnitDialog = new FSLNewLearningUnitDialog(learningUnitViewsManager.getInstalledLearningUnitViewManagersIdsAndTitles());
        learningUnitPropertiesDialog = new FSLLearningUnitPropertiesDialog(learningUnitViewsManager.getInstalledLearningUnitViewManagersIdsAndTitles());
        dataChanged = true;
        tourCreator = new FSLGuidedTourCreator(this, learningUnitsOriginalDataDirectory);
        tourCreator.registerFLG2TourCreatorInteractor(new FSLLearningUnitsManager_TourCreatorInteractor());

        /*** Jens Sieberg 03.08.2006 ***/
        // temporary disabled
        unitmap = new Unitmap(this, userEventGenerator, learningUnitsDescriptor);
        userEventGenerator.addUserListener(unitmap.getUserListener()); 
        /*** Ende Jens Sieberg ***/
        
        buildIndependentUI();
        buildDependentUI();
        progressStatus.setStatusValue(progressStatus.getStatusValue() + (int)(progressStatus.getStepSize() / 3.));
        newLearningUnitDialog = new FSLNewLearningUnitDialog(learningUnitViewsManager.getInstalledLearningUnitViewManagersIdsAndTitles());
        learningUnitsStructureTreePanel = new FSLLearningUnitsStructureTreePanel();
        this.progressDialog = progressDialog;
        // tbd: check if directory is writable!
        
        openUSSAccountData = new String[2];
    }
    
    /**
     * Request progress status from current Learning Unit View Manager.
     * @param <code>String</code> learningUnitId
     * @return <code>double</code> status
     */
    public double getLearningUnitProgressStatus(String learningUnitId) {
        // loop all View Managers and calculate progress
        return Math.random();  // tbd
    }
    
    public String[] [] getInstalledLearningUnitViewManagersIdsAndTitles() {
        return learningUnitViewsManager.getInstalledLearningUnitViewManagersIdsAndTitles();
    }
    
    public File getLearningUnitsDirectory() {
    	return configurationManager.getLearningUnitsDirectory();
    }
    
    public FSLLearningUnitViewsManager getLearningUnitViewsManager() {
        return learningUnitViewsManager;
    }
    
    public JMenu getLearningUnitMenu() {
        return learningUnitMenu;
    }
    
    public JPanel getLearningUnitSelectionPanel() {
        return learningUnitSelectionPanel;
    }
    
    public JPanel getLearningUnitViewsPrimaryButtonsPanel() {
        return learningUnitViewsManager.getLearningUnitViewsPrimaryButtonsPanel();
    }
    
    public JPanel getLearningUnitViewElementContentPanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewElementContentPanelContainer();
    }
    
    public String getLearningUnitPath() {
        return currentLearningUnitPath;
    }
    
    public FSLLearningUnitsDescriptor getLearningUnitsDescriptor() {
    	return learningUnitsDescriptor;
    }
    
    public boolean getIserRoleIsAuthor() {
    	return userRoleIsAuthor;
    }
    
    /**
     * Returns current fsl user name.
     * @return <code>String</code> current fsl user name
     */
    public String getUserName() {
        return currentUserName;
    }
    
    /**
     * Returns current openuss user name.
     * @return <code>String</code> current openuss user name
     */
    public String getOpenussUserName() {
    	return openUSSAccountData[0];
    }
    
    /**
     * Returns current openuss password.
     * @return <code>String</code> current openuss password
     */
    public String getOpenussPassword() {
    	return openUSSAccountData[1];
    }

    //added by Gunnar Thies
    /**
     * This method returns the contextDependentInteractionPanel
     * (invokes the method in FSLLearningUnitViewsManager to get the JPanel)
     */
    public JPanel getLearningUnitViewContextDependentInteractionPanelContainer() {
        return FSLLearningUnitViewsManager.getLearningUnitViewContextDependentInteractionPanelContainer();
    }
    //Gunnar Thies finished.
    
    public JPanel getLearningUnitViewElementsStructurePanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewElementsStructurePanelContainer();
    }
    
    public JPanel getLearningUnitViewElementInteractionPanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewElementInteractionPanelContainer();
    }
    
    public JPanel getLearningUnitViewStatusPanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewStatusPanelContainer();
    }
    
    public JPanel getLearningUnitViewAssistantPanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewAssistantPanelContainer();
    }
    
    public JPanel getLearningUnitViewContextDependentActivationPanelContainer() {
        return learningUnitViewsManager.getLearningUnitViewContextDependentActivationPanelContainer();
    }
    
    public JPanel getMainFrameToolBarButtonsPanel() {
        return mainFrameToolBarButtonsPanel;
    }
    
    public void addLearningUnitListener(FSLLearningUnitListener listener) {
        learningUnitListeners.add(listener);
    }
    
    public void removeLearningUnitListener(FSLLearningUnitListener listener) {
        learningUnitListeners.remove(listener);
    }
    
    public String getCurrentLearningUnitId() {
        return currentLearningUnitId;
    }
    
    /**
     * Set active Learning Unit by given Learning Unit Id.
     * @param <code>String</code> learningUnitId
     * @return <code>boolean</code> true if activation was succesfull
     */
    public boolean setActiveLearningUnit(String learningUnitId) {
        boolean activated = false;
        if (learningUnitId != null) {
            try {
                // set title
                label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
                label_selectedLearningUnit.setText(learningUnitsDescriptor.getDescriptorById(learningUnitId).getTitle());
                label_selectedLearningUnit.setToolTipText(label_selectedLearningUnit.getText());
                if (!learningUnitId.equals(currentLearningUnitId)) {
                    boolean canceled = false;
                    if (currentLearningUnitId != null) {
                        canceled = !askUserForSavingUnchangedData();
                    }
                    if (!canceled) {
                        FSLLearningUnitVetoableEvent vetoableEvent =
                        FSLLearningUnitVetoableEvent.createLearningUnitActivatingEvent();
                        fireLearningUnitEvent(vetoableEvent);
                        if (!vetoableEvent.isVeto()) {
                            if (learningUnitId != null) {
                                try {
                                    loadLearningUnit(learningUnitId);
                                }
                                catch (FSLLearningUnitNotInstalledException e) {
                                    FLGOptionPane.showMessageDialog(e.getMessage(), internationalization.getString("title.error.loadingLearningUnit"),
                                    FLGOptionPane.ERROR_MESSAGE);
                                    return false;
                                }
                            }
                            currentLearningUnitId = learningUnitId;
                            java.util.List learningUnitDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
                            for (int i = 0; i < learningUnitDescriptorList.size(); i++) {
                                FSLLearningUnitDescriptor learningUnitDescriptor =
                                (FSLLearningUnitDescriptor)learningUnitDescriptorList.get(i);
                                if (learningUnitDescriptor.getId().equals(currentLearningUnitId)) {
                                    currentLearningUnitPath = learningUnitDescriptor.getPath();
                                    currentLearningUnitTitle = learningUnitDescriptor.getTitle();
                                }
                            }
                            fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitActivatedEvent(currentLearningUnitId,
                            currentLearningUnitTitle, currentLearningUnitPath));
                            if (currentLearningUnitId != null) {
                                loadLearningUnitProperties();
                                activated = true;
                            }
                        }
                    }
                    buildDependentUI();
                }
                else {
                    activated = true;
                }
            }
            catch(Exception ex) {
                String message = internationalization.getString("dialog.errorFollowLink.message"); // + "\n\n" + ex.getMessage();
                String title = internationalization.getString("dialog.errorFollowLink.title");
                FLGOptionPane.showMessageDialog(message, title, FLGOptionPane.ERROR_MESSAGE);
            }
        }
        return activated;
    }
    
    public String getActiveLearningUnitId() {
        return currentLearningUnitId;
    }
    
    public String getLearningUnitTitle(String learningUnitId) {
        FSLLearningUnitDescriptor learningUnitDescriptor = findLearningUnitDescriptorById(learningUnitId);
        if (learningUnitDescriptor != null) {
            return learningUnitDescriptor.getTitle();
        }
        else {
            return null;
        }
    }
    
    public String getLearningUnitOpenUssServerName(String learningUnitId) {
        FSLLearningUnitDescriptor learningUnitDescriptor = findLearningUnitDescriptorById(learningUnitId);
        if (learningUnitDescriptor != null) {
            return learningUnitDescriptor.getOpenUssServerName();
        }
        else {
            return null;
        }
    }
    
    public String getLearningUnitEnrollmentId(String learningUnitId) {
        FSLLearningUnitDescriptor learningUnitDescriptor = findLearningUnitDescriptorById(learningUnitId);
        if (learningUnitDescriptor != null) {
            return learningUnitDescriptor.getEnrollmentId();
        }
        else {
            return null;
        }
    }
    
    public String[] getInstalledLearningUnitsIds() {
        Vector learningUnitIds = new Vector();
        java.util.List learningUnitDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
        for (int i = 0; i < learningUnitDescriptorList.size(); i++) {
            FSLLearningUnitDescriptor learningUnitDescriptor = (FSLLearningUnitDescriptor)learningUnitDescriptorList.get(i);
            learningUnitIds.add(learningUnitDescriptor.getId());
        }
        if (learningUnitIds.size() > 0) return (String[]) learningUnitIds.toArray(
        new String[] { });
        else
            return null;
    }
    
    public String[] getLearningUnitViewManagersIdsOfLearningUnit(String learningUnitId) {
        FSLLearningUnitDescriptor learningUnitDescriptor = findLearningUnitDescriptorById(learningUnitId);
        if (learningUnitDescriptor != null)
            return (String[]) learningUnitDescriptor.getLearningUnitViewManagers().toArray(
            new String[] { });
        else
            return null;
    }
    
    public void loadLearningUnit(String learningUnitId) throws FSLLearningUnitNotInstalledException {
        if (learningUnitId != null && !learningUnitId.equals(currentLearningUnitId)) {
            dataChanged = true;
            FLGUIUtilities.startLongLastingOperation();
            FSLLearningUnitDescriptor learningUnitDescriptor = findLearningUnitDescriptorById(learningUnitId);
            if (learningUnitDescriptor != null) {
                currentLearningUnitPath = learningUnitDescriptor.getPath();
                currentLearningUnitViewManagersIdList = learningUnitDescriptor.getLearningUnitViewManagers();
                learningUnitViewsManager.loadLearningUnitViewManagers(currentLearningUnitViewManagersIdList);
                learningUnitViewsManager.loadLearningUnitViewsData(learningUnitId, currentLearningUnitPath, currentLearningUnitViewManagersIdList);
                FLGUIUtilities.stopLongLastingOperation();
            }
            else {
                FLGUIUtilities.stopLongLastingOperation();
                throw new FSLLearningUnitNotInstalledException(internationalization.getString("message.learningUnitNotInstalled"));
            }
        }
    }
    
    public boolean programIsClosing() {
        boolean ok = askUserForSavingUnchangedData();
        if (ok) {
            if (learningUnitsDescriptor.isModified()) {
                ok = saveLearningUnitsDescriptor();
            }
        }
        return ok;
    }
    
    /**
     * Method is invoked, if user has moved a learning unit in learning unit structure tree.
     * @param  <code>FSLLearningUnitsDescriptor</code> learningUnitsDescriptor
     */
    public void updateFSLLearningUnitsDescriptor(FSLLearningUnitsDescriptor learningUnitsDescriptor) {
        this.learningUnitsDescriptor = learningUnitsDescriptor;
        saveLearningUnitsDescriptor();
        // update learning units structure tree
        learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
    }
    
    /**
     * Saves Learning Unit Descriptor.
     * @param <code>FSLLearningUnitsDescriptor<code> learningUnitsDescriptor
     * @return <code>boolean</code> true if descriptor is saved successfully
     */
    public boolean saveLearningUnitsDescriptor(FSLLearningUnitsDescriptor learningUnitsDescriptor) {
        File file = new File(learningUnitsOriginalDataDirectory, "learningUnitsDescriptor.xml");
        File backUpFile = new File(learningUnitsOriginalDataDirectory, "learningUnitsDescriptor.xml~");
        if (learningUnitsDescriptor.isModified()) {
            try {
                FLGFileUtility.copyFile(file, backUpFile);
                FileOutputStream fileOutputStream = new FileOutputStream(file);
                learningUnitsDescriptor.validate();
                learningUnitsDescriptor.marshal(fileOutputStream);
                fileOutputStream.close();
                learningUnitsDescriptor.setModified(false);
                backUpFile.delete();
                return true;
            }
            catch (Exception e) {
                e.printStackTrace();
                String message = internationalization.getString("dialog.message.errorSaving") + "\n" + file.getPath() +
                "\n\n" + internationalization.getString("dialog.message.checkFileProperties");
                FLGOptionPane.showMessageDialog(message, internationalization.getString("dialog.title.errorSaving"),
                FLGOptionPane.ERROR_MESSAGE);
                FLGFileUtility.copyFile(backUpFile, file);
                return false;
            }
        }
        return false;
    }
    
    private boolean saveLearningUnitsDescriptor() {
        return saveLearningUnitsDescriptor(learningUnitsDescriptor);
    }
    
    private void setEditMode(boolean editModeRequested) {
        if (editModeRequested) {
            try {
                if (isLearningUnitBeeingEditedByAnotherAuthor()) {
                    // Original Data beeing edited, ask for write acces
                    if (FLGOptionPane.showConfirmDialog(internationalization.getString("dialog.message.learningUnitBeeingEdited"),
                    internationalization.getString("dialog.title.errorEnteringEditMode"),
                    FLGOptionPane.YES_NO_OPTION, FLGOptionPane.WARNING_MESSAGE) == FLGOptionPane.YES_OPTION) {
                        enterEditMode(true);
                    }
                    else {
                        ((JCheckBoxMenuItem)menuItem_edit).setSelected(false);
                    }
                    return;
                }
            }
            catch (FSLEditModeException e) {
                // Error mode could not be entered
                FLGOptionPane.showMessageDialog(e.getMessage(), e.getTitle(), FLGOptionPane.ERROR_MESSAGE);
                enterEditMode(false);
                return;
            }
            enterEditMode(true);
        }
        else {
            // disable EditMode
            enterEditMode(false);
        }
    }
    
    public void enterEditMode(boolean doEnter) {
        editMode = doEnter;
        ((JCheckBoxMenuItem)menuItem_edit).setSelected(editMode);
        // getAction("menu.learningUnit.save.title").setEnabled(currentLearningUnitId != null && editMode);
        if (editMode) {
            saveLearningUnitProperties(currentUserName);
        }
        else {
            saveLearningUnitProperties("");
        }
        checkButtonsEnabled();
        fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitEditModeChangedEvent(editMode));
    }
    
    private boolean isLearningUnitBeeingEditedByAnotherAuthor() throws FSLEditModeException {
        boolean isBeingEditedByAnotherAuthor = false;
        learningUnitProperties = loadLearningUnitProperties();
        if (learningUnitProperties == null)
            throw new FSLEditModeException(internationalization.getString("message.luproperties_error.message"),
            internationalization.getString("message.luproperties_error.title"));
        if (userRoleIsAuthor) {
            EditStatus editStatus = learningUnitProperties.getEditStatus();
            String currentEditor = editStatus.getCurrentlyEditedBy();
            if (!currentUserName.equalsIgnoreCase(currentEditor) && (currentEditor.length() > 0)) {
                isBeingEditedByAnotherAuthor = true;
            }
        }
        return isBeingEditedByAnotherAuthor;
    }
    
    private FSLLearningUnitProperties loadLearningUnitProperties() {
        File learningUnitDirectory = new File(currentLearningUnitPath);
        if (learningUnitDirectory.exists()) {
            File learningUnitPropertiesFile = new File(currentLearningUnitPath, "learningUnitProperties.xml");
            try {
                if (!learningUnitPropertiesFile.exists()) {
                    learningUnitPropertiesFile.createNewFile();
                    writeNewLearningUnitPropertiesFile(learningUnitPropertiesFile);
                }
            }
            catch (IOException e) {
                System.out.println("FSLLearningUnitsManager.loadLearningUnitProperties(): " + e);
            }
            Dispatcher dispatcher = LearningUnitProperties.newDispatcher();
            dispatcher.register(LearningUnitProperties.class, FSLLearningUnitProperties.class);
            dispatcher.register(EditStatus.class, FSLEditStatus.class);
            FileInputStream learningUnitPropertiesFileInputStream = null;
            try {
                learningUnitPropertiesFileInputStream = new FileInputStream(learningUnitPropertiesFile);
                learningUnitProperties = (FSLLearningUnitProperties)dispatcher.unmarshal(learningUnitPropertiesFileInputStream);
                learningUnitPropertiesFileInputStream.close();
            }
            catch (Exception e) {
                System.out.println("FSLLearningUnitsManager.loadLearningUnitProperties(): " + e);
            }
            return learningUnitProperties;
        }
        return null;
    }
    
    private void writeNewLearningUnitPropertiesFile(File file) {
        FSLLearningUnitProperties learningUnitProperties = new FSLLearningUnitProperties();
        EditStatus editStatus = new EditStatus();
        editStatus.setCurrentlyEditedBy("");
        learningUnitProperties.setEditStatus(editStatus);
        try {
            FileOutputStream fileOutputStream = new FileOutputStream(file);
            learningUnitProperties.validate();
            learningUnitProperties.marshal(fileOutputStream);
            fileOutputStream.close();
        }
        catch (Exception e) {
            System.out.println("FSLLearningUnitsManager.writeNewLearningUnitPropertiesFile(): " + e);
        }
    }
    
    private void saveLearningUnitProperties(String currentEditor) {
        File file = new File(currentLearningUnitPath, "learningUnitProperties.xml");
        if (file.exists()) {
            if (learningUnitProperties == null) {
                learningUnitProperties = new FSLLearningUnitProperties();
                learningUnitProperties.setEditStatus(new EditStatus());
            }
            EditStatus editStatus = learningUnitProperties.getEditStatus();
            if (currentEditor != null) {
                if ((userRoleIsAuthor)) {
                    editStatus.setCurrentlyEditedBy(currentEditor);
                }
            }
            else {
                editStatus.setCurrentlyEditedBy("");
            }
            try {
                FileOutputStream fileOutputStream = new FileOutputStream(file);
                learningUnitProperties.validate();
                learningUnitProperties.marshal(fileOutputStream);
                fileOutputStream.close();
            }
            catch (Exception e) {
                System.out.println("FSLLearningUnitsManager.saveLearningUnitProperties(): " + e);
            }
        }
    }
    
    /**
     * Method invokes loading the views/elements of selected learning unit.
     */
    public void learningUnitSelected() {
        FSLLearningUnitDescriptor selectedLearningUnitDescriptor = learningUnitsStructureTreePanel.getSelectedLearningUnitDescriptor();
        if (selectedLearningUnitDescriptor!=null) {
            if (selectedLearningUnitDescriptor.getFolder()) {
                // open message window
                JPanel errorPanel = new JPanel();
                errorPanel.add(new JLabel(internationalization.getString("dialog.error_message.loading_category")));
                int returnValue = FLGOptionPane.showConfirmDialog(errorPanel, internationalization.getString("dialog.error_message.loading_category.window_title") , FLGOptionPane.OK_OPTION, FLGOptionPane.ERROR_MESSAGE);
                if (returnValue==FLGOptionPane.OK_OPTION) {
                    learningUnitsStructureTreePanel.init(learningUnitsDescriptor, FSLLearningUnitsManager.this);
                    learningUnitsStructureTreePanel.openOptionPane();
                }
            } else {
                // load learning unit by id
                setActiveLearningUnit(selectedLearningUnitDescriptor.getId());
                label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
                label_selectedLearningUnit.setText(selectedLearningUnitDescriptor.getTitle());
                label_selectedLearningUnit.setToolTipText(label_selectedLearningUnit.getText());
            }
        } else {
            JPanel errorPanel = new JPanel();
            errorPanel.add(new JLabel(internationalization.getString("dialog.error_message.loading_nothing_selected")));
            int returnValue = FLGOptionPane.showConfirmDialog(errorPanel, internationalization.getString("dialog.error_message.loading_nothing_selected_window_title") , FLGOptionPane.OK_OPTION, FLGOptionPane.ERROR_MESSAGE);
            if (returnValue==FLGOptionPane.OK_OPTION) {
                learningUnitsStructureTreePanel.init(learningUnitsDescriptor, FSLLearningUnitsManager.this);
                learningUnitsStructureTreePanel.openOptionPane();
            }
        }
    }
    
    /**
     * Deletes a learning unit or learning Unit category.
     * If learningUnitDescriptor is null, current learning unit will be deleted.
     * @param <code>FSLLearningUnitDescriptor</code> learningUnitDescriptor
     */
    public void deleteLearningUnit(FSLLearningUnitDescriptor learningUnitDescriptor) {
        // check, if user really wants to delete
        int returnValue = FLGOptionPane.showConfirmDialog(internationalization.getString("dialog.confirmDelete.message"),
        internationalization.getString("dialog.confirmDelete.title"),
        FLGOptionPane.YES_NO_OPTION, FLGOptionPane.QUESTION_MESSAGE);
        if (returnValue == FLGOptionPane.YES_OPTION) {
            if (learningUnitDescriptor==null) {
                java.util.List list = learningUnitsDescriptor.getLearningUnitsDescriptors();
                // get descriptor to current learning unit id
                for (int i=0; i<list.size(); i++) {
                    FSLLearningUnitDescriptor descriptor = (FSLLearningUnitDescriptor) list.get(i);
                    if (descriptor.getId().equals(currentLearningUnitId)) {
                        learningUnitDescriptor = descriptor;
                        break;
                    }
                }
                
            }
            if (!learningUnitDescriptor.getFolder()) {
                File learningUnitDirectory = new File(learningUnitDescriptor.getPath());
                FLGUIUtilities.startLongLastingOperation();
                FLGFileUtility.deleteDirectory(learningUnitDirectory);
                File usersDirectory = new File((new File(learningUnitsUserDataDirectory.getParent())).getParent());
                File[] userDirectories = FLGFileUtility.listDirectories(usersDirectory);
                for (int i = 0; i < userDirectories.length; i++) {
                    File userLearningUnitsDirectory = new File(userDirectories[i], "learningUnits");
                    File[] userLearningUnitsDirectories = FLGFileUtility.listDirectories(userLearningUnitsDirectory);
                    for (int j = 0; j < userLearningUnitsDirectories.length; j++) {
                        if (userLearningUnitsDirectories[j].getName().equals(learningUnitDirectory.getName())) {
                            FLGFileUtility.deleteDirectory(userLearningUnitsDirectories[j]);
                        }
                    }
                }
            }
            // remove all children
            Vector childrenVector = new Vector();
            if (learningUnitDescriptor.getFolder()) {
                java.util.List learningUnitsfromFSLLearningUnitsDescriptor = learningUnitsDescriptor.getLearningUnitsDescriptors();
                Iterator iter = learningUnitsfromFSLLearningUnitsDescriptor.iterator();
                while (iter.hasNext()) {
                    FSLLearningUnitDescriptor learnUnitDesc = (FSLLearningUnitDescriptor) iter.next();
                    if (learnUnitDesc.getParentID()!=null) {
                        if (learnUnitDesc.getParentID().equals(learningUnitDescriptor.getId())) {
                            childrenVector.add(learnUnitDesc);
                            // if no folder, delete
                            if (!learnUnitDesc.getFolder()) {
                                File folderToDelete = new File(learnUnitDesc.getPath());
                                folderToDelete.delete();
                            }
                        }
                    }
                }
            }
            this.learningUnitsDescriptor.getLearningUnitsDescriptors().remove(learningUnitDescriptor);
            if (childrenVector!=null) {
                for (int i=0; i<childrenVector.size();i++) {
                    learningUnitsDescriptor.getLearningUnitsDescriptors().remove((FSLLearningUnitDescriptor)childrenVector.get(i));
                }
            }
            learningUnitsDescriptor.setModified(true);
            saveLearningUnitsDescriptor();
            FLGUIUtilities.stopLongLastingOperation();
            // remove node from structure Tree
            learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
            // if no folder, delete
            if (!learningUnitDescriptor.getFolder()) {
                File folderToDelete = new File(learningUnitDescriptor.getPath());
                folderToDelete.delete();
            }
            if (currentLearningUnitId!=null && currentLearningUnitId.equals(learningUnitDescriptor.getId())) {
                currentLearningUnitId = null;
                currentLearningUnitTitle = null;
                currentLearningUnitPath = null;
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitActivatedEvent(currentLearningUnitId,
                currentLearningUnitTitle, currentLearningUnitPath));
                buildDependentUI();
                label_selectedLearningUnit.setText("");
            }
        } else {
            learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
        }
    }
    
    public boolean saveLearningUnit() {
        FLGUIUtilities.startLongLastingOperation();
        boolean savingOK = learningUnitViewsManager.saveLearningUnitViewsData();
        editMode = false;
        menuItem_edit.setSelected(false);
        dataChanged = savingOK;
        fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitEditModeChangedEvent(false));
        FLGUIUtilities.stopLongLastingOperation();
        return savingOK;
    }
    
    private void saveAsLearningUnit() {
        String learningUnitTitle = null;
        String learningUnitVersion = null;
        String learningUnitAuthors = null;
        String enrollmentId = null;
        String openUssServerName = null;
        FSLLearningUnitDescriptor learningUnitDescriptor = null;
        java.util.List learningUnitsDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
        java.util.List learningUnitViewManagers = null;
        String priorTitle = null;
        for (int i = 0; i < learningUnitsDescriptorList.size(); i++) {
            String id = ((FSLLearningUnitDescriptor)learningUnitsDescriptorList.get(i)).getId();
            if (id.equals(currentLearningUnitId)) {
                learningUnitDescriptor = (FSLLearningUnitDescriptor)learningUnitsDescriptorList.get(i);
                learningUnitTitle = learningUnitDescriptor.getTitle();
                learningUnitVersion = learningUnitDescriptor.getVersion();
                learningUnitAuthors = learningUnitDescriptor.getAuthors();
                if((learningUnitDescriptor.getOpenUssServerName())!= null) {
                	openUssServerName = learningUnitDescriptor.getOpenUssServerName(); 
                } else {
                	openUssServerName = "";
                }
                learningUnitViewManagers = learningUnitDescriptor.getLearningUnitViewManagers();
                break;
            }
        }
        priorTitle = learningUnitDescriptor.getTitle();
        if (learningUnitPropertiesDialog.showPropertiesDialog(currentLearningUnitId, openUssServerName, learningUnitTitle, learningUnitVersion,
        learningUnitAuthors, enrollmentId, learningUnitViewManagers)) {
            File presentLearningUnitDirectory = new File(learningUnitDescriptor.getPath());
            File newLearningUnitDirectory = FLGFileUtility.createNewFile("learningUnit", "",
            learningUnitsOriginalDataDirectory);
            newLearningUnitDirectory.mkdirs();
            // copy present data into new directory
            FLGUIUtilities.startLongLastingOperation();
            FLGFileUtility.copyDirectoryContent(presentLearningUnitDirectory, newLearningUnitDirectory);
            FLGUIUtilities.stopLongLastingOperation();
            // set new Learning Unit Descriptor
            learningUnitDescriptor = new FSLLearningUnitDescriptor();
            learningUnitDescriptor.setAuthors(learningUnitPropertiesDialog.getLearningUnitAuthors());
            learningUnitDescriptor.setPath(newLearningUnitDirectory.getAbsolutePath());
            learningUnitDescriptor.setId(learningUnitPropertiesDialog.getLearningUnitId());
            learningUnitDescriptor.setTitle(learningUnitPropertiesDialog.getLearningUnitTitle());
            learningUnitDescriptor.setVersion(learningUnitPropertiesDialog.getLearningUnitVersion());
            learningUnitDescriptor.emptyLearningUnitViewManagers();
            learningUnitDescriptor.getLearningUnitViewManagers().addAll(learningUnitPropertiesDialog.getSelectedLearningUnitViewManagersIds());
            this.learningUnitsDescriptor.getLearningUnitsDescriptors().add(learningUnitDescriptor);
            learningUnitsDescriptor.setModified(true);
            FSLLearningUnitVetoableEvent vetoableEvent = FSLLearningUnitVetoableEvent.createLearningUnitCreatingEvent();
            fireLearningUnitEvent(vetoableEvent);
            if (!vetoableEvent.isVeto()) {
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitCreatedEvent(currentLearningUnitId));
            }
            currentLearningUnitId = learningUnitDescriptor.getId();
            saveLearningUnitsDescriptor();
        }
    }
    
    /**
     * Method is invoked from learning unit structure tree to create a new learning unit category.
     */
    public void showNewLearningUnitCategoryDialog() {
        newLearningUnitCategoryDialog = new FSLNewLearningUnitCategoryDialog(learningUnitsDescriptor);
        if (newLearningUnitCategoryDialog.showDialog()) {
            FSLLearningUnitDescriptor learningUnitDescriptor = new FSLLearningUnitDescriptor();
            learningUnitDescriptor.setId(newLearningUnitCategoryDialog.getlearningUnitCategoryId());
            learningUnitDescriptor.setTitle(newLearningUnitCategoryDialog.getlearningUnitCategoryTitle());
            learningUnitDescriptor.setFolder(true);
            learningUnitDescriptor.emptyLearningUnitViewManagers();
            this.learningUnitsDescriptor.getLearningUnitsDescriptors().add(learningUnitDescriptor);
            learningUnitsDescriptor.setModified(true);
            FSLLearningUnitVetoableEvent vetoableEvent = FSLLearningUnitVetoableEvent.createLearningUnitCreatingEvent();
            fireLearningUnitEvent(vetoableEvent);
            currentLearningUnitId = learningUnitDescriptor.getId();
            if (!vetoableEvent.isVeto()) {
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitCreatedEvent(currentLearningUnitId));
            }
            saveLearningUnitsDescriptor();
            learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
            learningUnitsStructureTreePanel.setSelectionPath(learningUnitDescriptor);
        }
    }
    
    /**
     * Opens New Learning Dialog.
     * Method is invoked from Structure Tree Popup Menu to create a new Learning Unit.
     * @param <code>boolean</code> structureTreeModific
     */
    public void showNewLearningUnitDialog(boolean structureTreeModific) {
        structureTreeModification = structureTreeModific;
        if (newLearningUnitDialog.showDialog()) {
            if (!learningUnitIdExists(newLearningUnitDialog.getLearningUnitId())) {
                File learningUnitDirectory = FLGFileUtility.createNamedDirectory(newLearningUnitDialog.getLearningUnitId(),
                "", learningUnitsOriginalDataDirectory);
                FSLLearningUnitDescriptor learningUnitDescriptor = new FSLLearningUnitDescriptor();
                learningUnitDescriptor.setId(newLearningUnitDialog.getLearningUnitId());
                learningUnitDescriptor.setTitle(newLearningUnitDialog.getLearningUnitTitle());
                String fileSeparator = "/";
                if (!configurationManager.getLearningUnitsDirectoryName().startsWith("./")) {
                    fileSeparator = System.getProperty("file.separator");
                }
                learningUnitDescriptor.setPath(configurationManager.getLearningUnitsDirectoryName() + fileSeparator + newLearningUnitDialog.getLearningUnitId());
                learningUnitDescriptor.setAuthors(newLearningUnitDialog.getLearningUnitAuthors());
                learningUnitDescriptor.setVersion(newLearningUnitDialog.getLearningUnitVersion());
                if (newLearningUnitDialog.isEnrollmentIdSelected()) {
                    learningUnitDescriptor.setEnrollmentId(newLearningUnitDialog.getEnrollmentId());
                    learningUnitDescriptor.setOpenUssServerName(newLearningUnitDialog.getOpenUssServerName());
                }
                learningUnitDescriptor.emptyLearningUnitViewManagers();
                learningUnitDescriptor.getLearningUnitViewManagers().addAll(newLearningUnitDialog.getSelectedLearningUnitViewManagersIds());
                this.learningUnitsDescriptor.getLearningUnitsDescriptors().add(learningUnitDescriptor);
                learningUnitsDescriptor.setModified(true);
                FSLLearningUnitVetoableEvent vetoableEvent = FSLLearningUnitVetoableEvent.createLearningUnitCreatingEvent();
                fireLearningUnitEvent(vetoableEvent);
                currentLearningUnitId = learningUnitDescriptor.getId();
                if (!vetoableEvent.isVeto()) {
                    fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitCreatedEvent(currentLearningUnitId));
                }
                currentLearningUnitId=null;
                saveLearningUnitsDescriptor();
                newLearningUnitDialog.clearEntries();
                learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
                learningUnitsStructureTreePanel.setSelectionPath(learningUnitDescriptor);
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitActivatedEvent(currentLearningUnitId,
                currentLearningUnitTitle, currentLearningUnitPath));
                label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
                label_selectedLearningUnit.setText(internationalization.getString("learningUnitSelectionButton.init.label_selectedLearningUnit"));
                label_selectedLearningUnit.setToolTipText(label_selectedLearningUnit.getText());
            } else {
                FLGOptionPane.showMessageDialog(internationalization.getString("message.doubleLearningUnitId"),
                internationalization.getString("title.error.newLearningUnit"), FLGOptionPane.ERROR_MESSAGE);
                showNewLearningUnitDialog(structureTreeModification);
            }
        }
    }
    
    private boolean learningUnitIdExists(String newLearningUnitId) {
        java.util.List learningUnitDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
        for (int i = 0; i < learningUnitDescriptorList.size(); i++) {
            FSLLearningUnitDescriptor learningUnitDescriptor = (FSLLearningUnitDescriptor)learningUnitDescriptorList.get(i);
            if (learningUnitDescriptor.getId().equalsIgnoreCase(newLearningUnitId))
                return true;
        }
        return false;
    }
    
    /**
     * Method is invoked from learning units structure tree to rename learning unit categories.
     * @param <code>FSLLearningUnitDescriptor</code> selectedLearningUnitCategoryDescriptor
     */
    public void showPropertiesCategoryDialogAndUpdateStructureTree(FSLLearningUnitDescriptor selectedLearningUnitCategoryDescriptor) {
        learningUnitCategoryPropertiesDialog = new FSLLearningUnitCategoryPropertiesDialog(selectedLearningUnitCategoryDescriptor);
        learningUnitCategoryPropertiesDialog.showDialog();
        // set new title
        selectedLearningUnitCategoryDescriptor.setTitle(learningUnitCategoryPropertiesDialog.getLearningUnitCategoryTitle());
        learningUnitsDescriptor.setModified(true);
        //update learning unit structure tree
        learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
        learningUnitsStructureTreePanel.setSelectionPath(selectedLearningUnitCategoryDescriptor);
    }
    
    /**
     * Opens dialog for editting learning unit properties.
     * @param <code>FSLLearningUnitDescriptor</code> selectedLearningDescriptor
     */
    public void showPropertiesDialog(FSLLearningUnitDescriptor selectedLearningDescriptor) {
        String learningUnitId = null;
        String learningUnitVersion = null;
        String learningUnitAuthors = null;
        String enrollmentId = null;
        String openUssServerName = null;
        java.util.List learningUnitViewManagers = null;
        String priorTitle = null;
        FSLLearningUnitDescriptor learningUnitDescriptor=null;
        if (selectedLearningDescriptor!=null) {
            learningUnitDescriptor = selectedLearningDescriptor;
        } else {
            java.util.List list = learningUnitsDescriptor.getLearningUnitsDescriptors();
            // get descriptor to current learning unit id
            for (int i=0; i<list.size(); i++) {
                FSLLearningUnitDescriptor descriptor = (FSLLearningUnitDescriptor) list.get(i);
                if (descriptor.getId().equals(currentLearningUnitId)) {
                    learningUnitDescriptor = descriptor;
                    break;
                }
            }
            
        }
        learningUnitId = learningUnitDescriptor.getId();
        learningUnitVersion = learningUnitDescriptor.getVersion();
        learningUnitAuthors = learningUnitDescriptor.getAuthors();
        enrollmentId = learningUnitDescriptor.getEnrollmentId();
        if((learningUnitDescriptor.getOpenUssServerName())!= null) {
        	openUssServerName = learningUnitDescriptor.getOpenUssServerName(); 
        } else {
        	openUssServerName = "";
        }
        openUssServerName = learningUnitDescriptor.getOpenUssServerName();
        learningUnitViewManagers = learningUnitDescriptor.getLearningUnitViewManagers();
        priorTitle = learningUnitDescriptor.getTitle();
        if (learningUnitPropertiesDialog.showPropertiesDialog(learningUnitId, openUssServerName, learningUnitDescriptor.getTitle(), learningUnitVersion,
        learningUnitAuthors, enrollmentId, learningUnitViewManagers)) {
            learningUnitDescriptor.setAuthors(learningUnitPropertiesDialog.getLearningUnitAuthors());
            learningUnitDescriptor.setId(learningUnitPropertiesDialog.getLearningUnitId());
            learningUnitDescriptor.setTitle(learningUnitPropertiesDialog.getLearningUnitTitle());
            learningUnitDescriptor.setVersion(learningUnitPropertiesDialog.getLearningUnitVersion());
            learningUnitDescriptor.setEnrollmentId(learningUnitPropertiesDialog.getEnrollmentId());
            learningUnitDescriptor.setOpenUssServerName(learningUnitPropertiesDialog.getOpenUssServerName());
            learningUnitDescriptor.emptyLearningUnitViewManagers();
            learningUnitDescriptor.getLearningUnitViewManagers().addAll(learningUnitPropertiesDialog.getSelectedLearningUnitViewManagersIds());
            learningUnitsDescriptor.setModified(true);
            FSLLearningUnitVetoableEvent vetoableEvent = FSLLearningUnitVetoableEvent.createLearningUnitCreatingEvent();
            fireLearningUnitEvent(vetoableEvent);
            if (!vetoableEvent.isVeto()) {
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitCreatedEvent(currentLearningUnitId));
            }
            saveLearningUnitsDescriptor();
            // update strucutre tree
            learningUnitsStructureTreePanel.updateTree(learningUnitsDescriptor);
            learningUnitsStructureTreePanel.setSelectionPath(learningUnitDescriptor);
            // if learning unit is selected, reload
            if (learningUnitDescriptor.getId().equals(currentLearningUnitId)) {
                label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
                label_selectedLearningUnit.setText(learningUnitDescriptor.getTitle());
                label_selectedLearningUnit.setToolTipText(label_selectedLearningUnit.getText());
                currentLearningUnitId=null;
                setActiveLearningUnit(learningUnitDescriptor.getId());
                currentLearningUnitId=learningUnitDescriptor.getId();
            }
        }
    }
    
    /*** Jens Sieberg 09.08.2006 
     * This method needs to be edited if
     * if the prerequisites are no longer saved with the learningUnitDescriptor***/
    public java.util.List getLearningUnitPrerequisites(String learningUnitId)
    {
    	FSLLearningUnitDescriptor learningUnitDescriptor = null;
    	java.util.List list = learningUnitsDescriptor.getLearningUnitsDescriptors();
    	// get descriptor to learning unit id
    	for (int i=0; i<list.size(); i++) {
    		FSLLearningUnitDescriptor descriptor = (FSLLearningUnitDescriptor) list.get(i);
    		if (descriptor.getId().equals(learningUnitId)) {
    			learningUnitDescriptor = descriptor;
    			break;
    		}
    	}
    	
    	return learningUnitDescriptor.getPrerequisites();
    }
    
    public void addLearningUnitPrerequisites(java.util.List prerequisiteIds, String learningUnitId)
    {
    	FSLLearningUnitDescriptor learningUnitDescriptor = null;
    	java.util.List list = learningUnitsDescriptor.getLearningUnitsDescriptors();
    	// get descriptor to learning unit id
    	for (int i=0; i<list.size(); i++) {
    		FSLLearningUnitDescriptor descriptor = (FSLLearningUnitDescriptor) list.get(i);
    		if (descriptor.getId().equals(learningUnitId)) {
    			learningUnitDescriptor = descriptor;
    			break;
    		}
    	}
    	
   		//if (learningUnitDescriptor.getPrerequisites() == null)
   		learningUnitDescriptor.emptyPrerequisites(); 

    	learningUnitDescriptor.getPrerequisites().addAll(prerequisiteIds); 
    	
    	learningUnitsDescriptor.setModified(true);
    	
    	saveLearningUnitsDescriptor();
    }
    
    public void removeLearningUnitPrerequisite(String prerequisiteId, String learningUnitId)
    {
    	FSLLearningUnitDescriptor learningUnitDescriptor = null;
    	java.util.List list = learningUnitsDescriptor.getLearningUnitsDescriptors();
    	// get descriptor to learning unit id
    	for (int i=0; i<list.size(); i++) {
    		FSLLearningUnitDescriptor descriptor = (FSLLearningUnitDescriptor) list.get(i);
    		if (descriptor.getId().equals(learningUnitId)) {
    			learningUnitDescriptor = descriptor;
    			break;
    		}
    	}
    	
    	learningUnitDescriptor.getPrerequisites().remove(prerequisiteId); 
    	if (learningUnitDescriptor.getPrerequisites().size() == 0) 
    		learningUnitDescriptor.deletePrerequisites(); 
    	
    	learningUnitsDescriptor.setModified(true);

    	saveLearningUnitsDescriptor();
    }
    /*** Ende Jens Sieberg ***/
    
    private void showEditStructureDialog() {
        exportStructureDialog = new FSLExportLearningUnitViewStructureDialog(getImportStructureSupportingViewManagerIdsAndTitles());
        if (exportStructureDialog.showDialog()) {
            exportStructure(exportStructureDialog.getExportFromLearningUnitViewManagerId(),
            exportStructureDialog.getExportToLearningUnitViewManagerIds());
        }
    }
    
    private void exportStructure(String exportFromManagerId, String[] exportToManagerId) {
        // get data to export from source manager
        FSLLearningUnitViewManager exportFromManager = learningUnitViewsManager.getLearningUnitViewManager(exportFromManagerId);
        exportFromManager.loadLearningUnitViewData(currentLearningUnitId,
        exportFromManager.getLearningUnitViewOriginalDataDirectory(),
        exportFromManager.getLearningUnitViewUserDirectory());
        // get target view managers
        FSLLearningUnitViewManager[] exportToManagers = new FSLLearningUnitViewManager[exportToManagerId.length];
        for (int i = 0; i < exportToManagers.length; i++) {
            exportToManagers[i] = learningUnitViewsManager.getLearningUnitViewManager(exportToManagerId[i]);
            // export source structure to target manager
            exportToManagers[i].importStructure(exportFromManager.getLearningUnitViewElementsManager());
        }
    }
    
    private void showPropertiesDialog() {
        String learningUnitTitle = null;
        String learningUnitVersion = null;
        String learningUnitAuthors = null;
        String enrollmentId = null;
        String openUssServerName = null;
        FSLLearningUnitDescriptor learningUnitDescriptor = null;
        java.util.List learningUnitsDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
        java.util.List learningUnitViewManagers = null;
        String priorTitle = null;
        for (int i = 0; i < learningUnitsDescriptorList.size(); i++) {
            String id = ((FSLLearningUnitDescriptor)learningUnitsDescriptorList.get(i)).getId();
            if (id.equals(currentLearningUnitId)) {
                learningUnitDescriptor = (FSLLearningUnitDescriptor)learningUnitsDescriptorList.get(i);
                learningUnitTitle = learningUnitDescriptor.getTitle();
                learningUnitVersion = learningUnitDescriptor.getVersion();
                learningUnitAuthors = learningUnitDescriptor.getAuthors();
                learningUnitViewManagers = learningUnitDescriptor.getLearningUnitViewManagers();
                enrollmentId = learningUnitDescriptor.getEnrollmentId();
                openUssServerName = learningUnitDescriptor.getOpenUssServerName();
                break;
            }
        }
        priorTitle = learningUnitDescriptor.getTitle();
        if (learningUnitPropertiesDialog.showPropertiesDialog(currentLearningUnitId, openUssServerName, learningUnitTitle, learningUnitVersion,
        learningUnitAuthors, enrollmentId, learningUnitViewManagers)) {
            learningUnitDescriptor.setAuthors(learningUnitPropertiesDialog.getLearningUnitAuthors());
            learningUnitDescriptor.setId(learningUnitPropertiesDialog.getLearningUnitId());
            learningUnitDescriptor.setTitle(learningUnitPropertiesDialog.getLearningUnitTitle());
            learningUnitDescriptor.setVersion(learningUnitPropertiesDialog.getLearningUnitVersion());
            learningUnitDescriptor.setEnrollmentId(learningUnitPropertiesDialog.getEnrollmentId());
            learningUnitDescriptor.setOpenUssServerName(learningUnitPropertiesDialog.getOpenUssServerName());
            learningUnitDescriptor.emptyLearningUnitViewManagers();
            learningUnitDescriptor.getLearningUnitViewManagers().addAll(learningUnitPropertiesDialog.getSelectedLearningUnitViewManagersIds());
            learningUnitsDescriptor.setModified(true);
            FSLLearningUnitVetoableEvent vetoableEvent = FSLLearningUnitVetoableEvent.createLearningUnitCreatingEvent();
            fireLearningUnitEvent(vetoableEvent);
            if (!vetoableEvent.isVeto()) {
                fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitCreatedEvent(currentLearningUnitId));
            }
            currentLearningUnitId = null;
            saveLearningUnitsDescriptor();
            label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
            label_selectedLearningUnit.setText(learningUnitDescriptor.getTitle());
            label_selectedLearningUnit.setToolTipText(label_selectedLearningUnit.getText());
            setActiveLearningUnit(learningUnitDescriptor.getId());
        }
    }
    
    public boolean openUSSServerConnectionIsEstablished() {
    	if (openUSSAccountData[0]==null && !openUSSServerConnectionEstablished)  {
    		// open dialog for openuss login
    		FSLLearningUnitSynchronizeLoginDialog learningUnitSynchronizeLoginDialog = new FSLLearningUnitSynchronizeLoginDialog();
	    	if (learningUnitSynchronizeLoginDialog.showDialog()) {
	    		// check account data in openuss
	    		// get server name 
	    		FSLLearningUnitDescriptor learningUnitDescriptor = learningUnitsDescriptor.getDescriptorById(getActiveLearningUnitId());
        		String serverName = learningUnitDescriptor.getOpenUssServerName();
        		// init openuss web service client
        		FSLLearningUnitViewOpenUSSWebServiceClient webServiceClient = new FSLLearningUnitViewOpenUSSWebServiceClient(null, null,
        				serverName, learningUnitSynchronizeLoginDialog.getUserName(), learningUnitSynchronizeLoginDialog.getUserPassword());
        		if (webServiceClient.authenticateUser()) {
        			openUSSAccountData[0]= learningUnitSynchronizeLoginDialog.getUserName();
        			openUSSAccountData[1]= learningUnitSynchronizeLoginDialog.getUserPassword();
        			openUSSServerConnectionEstablished = true;
        		} else {
        			// user does not exist, open option pane
        			FLGOptionPane.showMessageDialog(internationalization.getString("learningUnitsManager.checkOpenUssUserData.errorDilog.text"), 
        					internationalization.getString("learningUnitsManager.checkOpenUssUserData.errorDilog.title"), FLGOptionPane.ERROR_MESSAGE);
        		}
	       	}
    	}
    	return openUSSServerConnectionEstablished;
    }
    
    private File openFileChooser(FSLLearningUnitDescriptor learningUnitDescriptor) {
        File selectedFile=null;
        JFileChooser fileDialog = new JFileChooser();
        fileDialog.setDialogTitle(internationalization.getString("exportFileDialog.title"));
        java.awt.Dimension screenDim = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        fileDialog.setLocation((int)(screenDim.getWidth() - fileDialog.getWidth()) / 2,
        (int)(screenDim.getHeight() - fileDialog.getHeight()) / 2);
        String fileExtension = ".fsl";
        fileDialog.setFileFilter(new FLGUIUtilities.FLGFileFilter(new String[] { fileExtension }, internationalization.getString("filedialog.zipfileDescription.text")));
        fileDialog.setSelectedFile(new File(learningUnitDescriptor.getId()+".fsl"));
        if (fileDialog.showSaveDialog(new JPanel()) == JFileChooser.APPROVE_OPTION) {
            selectedFile = fileDialog.getSelectedFile();
            // check, if selected file already exits
            File parentFile = new File(fileDialog.getSelectedFile().getParent());
            File[] children = parentFile.listFiles();
            boolean fileAlreadyExits=false;
            for (int i=0; i<children.length; i++) {
                if (children[i].equals(fileDialog.getSelectedFile())) {
                    fileAlreadyExits=true;
                    break;
                }
            }
            boolean overwriteFile=true;
            if (fileAlreadyExits) {
                // show overwrite message
                int returnValue = FLGOptionPane.showConfirmDialog(internationalization.getString("dialog.learningUnitExport.overwriteFile.message"),
                internationalization.getString("dialog.learningUnitExport.overwriteFile.windowTitle"),
                FLGOptionPane.OK_CANCEL_OPTION, FLGOptionPane.OK_CANCEL_OPTION);
                if (returnValue==FLGOptionPane.CANCEL_OPTION) {
                    openFileChooser(learningUnitDescriptor);
                    selectedFile=null;
                }
            }
        }
        return selectedFile;
    }
    
    /**
     * Exports Learning Units in zipped ".fsl"-files.
     * @param <code>FSLLearningUnitDescriptor</code> learningUnitDescriptor
     */
    public void exportLearningUnit(FSLLearningUnitDescriptor learningUnitDescriptor) {
        if (learningUnitDescriptor.getFolder()) {
            // open message window to show that category cannont be exported (not yet!)
            JPanel errorPanel = new JPanel();
            errorPanel.add(new JLabel(internationalization.getString("dialog.error_message.learning_unit_export")));
            int returnValue = FLGOptionPane.showConfirmDialog(errorPanel, internationalization.getString("dialog.error_message.learning_unit_export.window_title") , FLGOptionPane.OK_OPTION, FLGOptionPane.ERROR_MESSAGE);
        } else {
            // open dialog to selected target for fsl-file
            File selectedFile = openFileChooser(learningUnitDescriptor);
            if (selectedFile!=null) {
                // remove parents from learning unit in descriptor
                learningUnitDescriptor.setParentID(null);
                // set cross-plattform-path with plattform independent separators in exportdescriptor
                final String exportPath = learningUnitDescriptor.getPath();
                learningUnitDescriptor.setPath("./" + learningUnitsOriginalDataDirectory.getName() + "/" + learningUnitDescriptor.getId());
                // build new learning units descriptor instance
                FSLLearningUnitsDescriptor unitsDescriptor = new FSLLearningUnitsDescriptor();
                unitsDescriptor.getLearningUnitsDescriptors().add(learningUnitDescriptor);
                // create file for export descriptor
                final File exportDescriptorFile = new File(selectedFile.getParent(),"exportDescriptor.xml");
                try {
                	// write content into exportDescriptorFile
                    FileOutputStream fileOutputStream = new FileOutputStream(exportDescriptorFile);
                    unitsDescriptor.validate();
                    unitsDescriptor.marshal(fileOutputStream);
                    fileOutputStream.flush();
                    fileOutputStream.close();
                    // get output file name from file dialog and create zip file
                    File outputFile = selectedFile;
                    // check file extension --> if ".fsl" not exits, add file extension 
                    String fileName = outputFile.getName();
                    StringBuffer extension = new StringBuffer();
                    if (fileName.length()>=4) {
                        for (int i=4; i>0; i--) {
                            extension.append(fileName.charAt(fileName.length()-i));
                        }
                    }
                    if (!extension.toString().equals(".fsl")) {
                        // add ".fsl" extension
                        outputFile.renameTo(new File(outputFile.getAbsolutePath() + ".fsl"));
                        outputFile = new File(outputFile.getAbsolutePath() + ".fsl");
                    }
                    // create thread for writing files into zip output stream and show progress bar 
                    final FSLLearningUnitDescriptor learningUnitDesc = learningUnitDescriptor;
                    final File outFile = outputFile;
                    (new Thread() {
                        public void run() {
                            try {
                                ZipOutputStream zipOutputStream = new ZipOutputStream(new FileOutputStream(outFile));
                                // get all learning units elements to export and store them in zip file
                                File[] files = (new File(exportPath)).listFiles();
                                // progress bar settings
                                int maxSteps = files.length*100;
                                exportProgressDialog = new FLGImageProgressDialog(null, 0, maxSteps, 0,
                                		getClass().getClassLoader().getResource("freestyleLearning/homeCore/images/fsl.gif"), (Color)UIManager.get("FSLColorBlue"),
                                		(Color)UIManager.get("FSLColorRed"),internationalization.getString("learningUnit.export.progressbarText"));
                                //exportProgressDialog.setCursor(new Cursor(Cursor.WAIT_CURSOR));
                                exportProgressDialog.setIndeterminate(true);
                                // export files
                                try {
                                    for (int i=0; i<files.length; i++) {
                                        if (!(files[i].getName().equals("exportDescriptor.xml"))
                                        		&& !(files[i].getName().equals("exportDescriptor.xml_recovery"))) {
	                                        if (files[i].isDirectory()) {
	                                            // add directory and its subfolders
	                                        	ZipEntry newZipEntry = new ZipEntry(files[i].getName() + "/");
	                                            zipOutputStream.putNextEntry(newZipEntry);
	                                            zipOutputStream.closeEntry();
	                                            zipOutputStream.flush();
	                                            File[] subFiles = files[i].listFiles();
	                                            buildExportZipFile(files[i].getName(),zipOutputStream,subFiles);
	                                        } else {
	                                            ZipEntry newZipEntry;
	                                            newZipEntry = new ZipEntry(files[i].getName());
	                                            zipOutputStream.putNextEntry(newZipEntry);
	                                            InputStream is = new FileInputStream(files[i]);
	                                            byte[] buf = new byte[4096];
	                                            int len;
	                                            while ((len = is.read(buf)) > 0) {
	                                                zipOutputStream.write(buf, 0, len);
	                                            }
	                                            is.close();
	                                            zipOutputStream.closeEntry();
	                                            zipOutputStream.flush();
	                                        }
                                        }
                                    }
                                } catch (Exception exp) {
                                    exp.printStackTrace();
                                }
                                // copy export learning unit descriptor into zip archiv 
                                ZipEntry newZipEntry = new ZipEntry(exportDescriptorFile.getName());
                                zipOutputStream.putNextEntry(newZipEntry);
                                InputStream is = new FileInputStream(exportDescriptorFile);
                                byte[] buf = new byte[4096];
                                int len;
                                while ((len = is.read(buf)) > 0) {
                                    zipOutputStream.write(buf, 0, len);
                                }
                                is.close();
                                zipOutputStream.closeEntry();
                                zipOutputStream.flush();
                                zipOutputStream.finish();
                                zipOutputStream.close();
                                // delete learning unit descriptor
                                exportDescriptorFile.delete();
	                            // close stream and dipose progress bar
                                //progressDialog.setCursor(new Cursor(Cursor.DEFAULT_CURSOR));
                                exportProgressDialog.dispose();
                            } 
                            catch (NullPointerException npe) {
                                FLGOptionPane.showMessageDialog(internationalization.getString("dialog.exportError.message"), 
                                  internationalization.getString("dialog.exportError.title"), FLGOptionPane.ERROR_MESSAGE);
                            }
                            catch (Exception e) {
                                e.printStackTrace();
                            }
                        }
                    }).start();
                }
                catch (Exception exp) {
                    exp.printStackTrace();
                }
            }
        }
    }
    
    private void buildExportZipFile(String parentDirectory, ZipOutputStream zipOutputStream, File[] files) {
    	try {
            for (int i=0; i<files.length; i++) {
            	if (!(files[i].getName().equals("exportDescriptor.xml"))
            		&& !(files[i].getName().equals("exportDescriptor.xml_recovery"))) {
	                if (files[i].isDirectory()) {
	                    // add directory and its subfolders
	                    if (parentDirectory.equals("")) {
	                        ZipEntry newZipEntry = new ZipEntry(files[i].getName() + "/");
	                        zipOutputStream.putNextEntry(newZipEntry);
	                        zipOutputStream.closeEntry();
	                        zipOutputStream.flush();
	                        File[] subFiles = files[i].listFiles();
	                        buildExportZipFile(files[i].getName(),zipOutputStream,subFiles);
	                    } else {
	                        ZipEntry newZipEntry = new ZipEntry(parentDirectory
	                        + "/" + files[i].getName() + "/");
	                        zipOutputStream.putNextEntry(newZipEntry);
	                        zipOutputStream.closeEntry();
	                        zipOutputStream.flush();
	                        File[] subFiles = files[i].listFiles();
	                        buildExportZipFile(parentDirectory
	                        + "/" + files[i].getName(),zipOutputStream,subFiles);
	                    }
	                } else {
	                    ZipEntry newZipEntry;
	                    if (parentDirectory.equals("")) {
	                        newZipEntry = new ZipEntry(files[i].getName());
	                    } else {
	                        newZipEntry = new ZipEntry(parentDirectory
	                        + "/" + files[i].getName());
	                    }
	                    zipOutputStream.putNextEntry(newZipEntry);
	                    InputStream is = new FileInputStream(files[i]);
	                    byte[] buf = new byte[4096];
	                    int len;
	                    while ((len = is.read(buf)) > 0) {
	                        zipOutputStream.write(buf, 0, len);
	                    }
	                    is.close();
	                    zipOutputStream.closeEntry();
	                    zipOutputStream.flush();
	                }
            	}
            }
        } catch (Exception exp) {
            exp.printStackTrace();
        }
    }
    
    /**
     * Imports Learning Units.
     */
    public void importLearningUnit() {
        JFileChooser fileDialog = new JFileChooser();
        fileDialog.setDialogTitle(internationalization.getString("importFileDialog.title"));
        java.awt.Dimension screenDim = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        fileDialog.setLocation((int)(screenDim.getWidth() - fileDialog.getWidth()) / 2,
        (int)(screenDim.getHeight() - fileDialog.getHeight()) / 2);
        String fileExtension = ".fsl";
        fileDialog.setFileFilter(new FLGUIUtilities.FLGFileFilter(new String[] { fileExtension }, internationalization.getString("filedialog.zipfileDescription.text")));
        if (fileDialog.showOpenDialog(new JPanel()) == JFileChooser.APPROVE_OPTION) {
            try {
                final File inputFile = fileDialog.getSelectedFile();
                if (inputFile!=null) {
                    new Thread() {
                        public void run() {
                            try {
                                ZipFile zipFile = new ZipFile(inputFile);
                                FileInputStream fileInputStream = new FileInputStream(inputFile);
                                ZipInputStream zipInputStream = new ZipInputStream(fileInputStream);
                                ZipEntry entry = zipInputStream.getNextEntry();
                                boolean descriptorAlreadyExits = false;
                                FSLLearningUnitDescriptor learningUnitDescriptor = null;
                                while (entry!=null) {
                                    if (entry.getName().equals("exportDescriptor.xml")) {
                                        File exportDescriptorFile = new File(
                                        		learningUnitsOriginalDataDirectory.getAbsoluteFile() + "/"
                                        		+ "exportDescriptor.xml");
                                        // insert export descriptor file
                                        FileOutputStream out = new FileOutputStream(learningUnitsOriginalDataDirectory.getAbsoluteFile()
                                        + "/" + entry.getName());
                                        byte[] buf = new byte[4096];
                                        int len;
                                        while ((len = zipInputStream.read(buf)) > 0) {
                                            out.write(buf, 0, len);
                                        }
                                        out.close();
                                        // get learning unit descriptor entries
                                        FSLLearningUnitsDescriptor exportUnitsDescriptor = loadLearningUnitsDescriptor(exportDescriptorFile);
                                        java.util.List exportUnitDescriptor = exportUnitsDescriptor.getLearningUnitsDescriptors();
                                        learningUnitDescriptor = (FSLLearningUnitDescriptor)exportUnitDescriptor.get(0);
                                        
                                        if (configurationManager.getLearningUnitsDirectoryName().charAt(0)=='.') {
                                        	learningUnitDescriptor.setPath("./" + learningUnitsOriginalDataDirectory.getName() + "/"
                                        		+ learningUnitDescriptor.getId());
                                        } else {
                                        	learningUnitDescriptor.setPath(learningUnitsOriginalDataDirectory.getAbsolutePath() + "/"
                                            		+ learningUnitDescriptor.getId());
                                        }
                                        
                                        // get learning unit descriptor from current fsl installation
                                        java.util.List installedUnitDescriptors = learningUnitsDescriptor.getLearningUnitsDescriptors();
                                        // check, if learning unit id  already exits
                                        for (int i=0; i< installedUnitDescriptors.size(); i++) {
                                            FSLLearningUnitDescriptor instLearningUnitDescriptor = (FSLLearningUnitDescriptor)installedUnitDescriptors.get(i);
                                            if (learningUnitDescriptor.getId().equals(instLearningUnitDescriptor.getId())) {
                                                // open message window because learning unit id is already in use
                                                FLGOptionPane.showConfirmDialog(internationalization.getString("dialog.error_message.learning_unit_import") 
                                                		+ " " + learningUnitDescriptor.getId(), 
                                                		internationalization.getString("dialog.error_message.learning_unit_import.window_title") , FLGOptionPane.OK_OPTION, FLGOptionPane.ERROR_MESSAGE);
                                                descriptorAlreadyExits=true;
                                                break;
                                            }
                                        }
                                        // close streams
                                        fileInputStream.close();
                                        zipInputStream.close();
                                        zipFile.close();
                                        // delete export descriptor file
                                        //exportDescriptorFile.delete();
                                        break;
                                    }
                                    entry = zipInputStream.getNextEntry();
                                }
                                zipInputStream.close();
                                if (!descriptorAlreadyExits) {
                                    //int maxSteps = 50;
                                    //int step = 1;
                                    importProgressDialog = new FLGImageProgressDialog(null, 0, 200, 0,
                                    		getClass().getClassLoader().getResource("freestyleLearning/homeCore/images/fsl.gif"), (Color)UIManager.get("FSLColorBlue"),
                                    (	Color)UIManager.get("FSLColorRed"), internationalization.getString("learningUnit.import.progressbarText"));
                                    importProgressDialog.setCursor(new Cursor(Cursor.WAIT_CURSOR));
                                    importProgressDialog.setIndeterminate(true);
                                    // modify descriptor
                                    (FSLLearningUnitsManager.this).learningUnitsDescriptor.getLearningUnitsDescriptors().add(learningUnitDescriptor);
                                    learningUnitsDescriptor.setModified(true);
                                    saveLearningUnitsDescriptor();
                                    // store files
                                    new File(learningUnitsOriginalDataDirectory.getAbsoluteFile() + "/" + learningUnitDescriptor.getId()).mkdir();
                                    zipFile = new ZipFile(inputFile);
                                    zipInputStream = new ZipInputStream(new FileInputStream(inputFile));
                                    entry = zipInputStream.getNextEntry();
                                    while (entry!=null) {
                                        if (entry!=null && entry.isDirectory()) {
                                            File f = new File(learningUnitsOriginalDataDirectory.getAbsoluteFile() + "/"
                                            + learningUnitDescriptor.getId() + "/"
                                            + entry.getName());
                                            f.mkdir();
                                        }
                                        else {
                                            FileOutputStream out = new FileOutputStream(
                                            learningUnitsOriginalDataDirectory.getAbsoluteFile() + "/"
                                            + learningUnitDescriptor.getId() + "/"
                                            + entry.getName());
                                            byte[] buf = new byte[4096];
                                            int len;
                                            while ((len = zipInputStream.read(buf)) > 0) {
                                                out.write(buf, 0, len);
                                            }
                                            out.close();
                                        }
                                        zipInputStream.closeEntry();
                                        entry = zipInputStream.getNextEntry();
                                    }
                                    zipInputStream.close();
                                    importProgressDialog.dispose();
                                }
                            }
                            catch (Exception ex) {
                                ex.printStackTrace();
                            }
                        }
                    }.start();
                }
            }
            catch(Exception exp) {
                exp.printStackTrace();
            }
        }
    }
        
    // return value: true, if user agreed
    private boolean askUserForSavingUnchangedData() {
        boolean savingOK = true;
        if (currentLearningUnitId != null && learningUnitViewsManager.learningUnitViewsDataChanged()) {
            int returnValue = FLGOptionPane.showConfirmDialog(internationalization.getString("dialog.saveUserChanges.message"),
            internationalization.getString("dialog.saveUserChanges.title"),
            FLGOptionPane.YES_NO_CANCEL_OPTION, FLGOptionPane.QUESTION_MESSAGE);
            if (returnValue == FLGOptionPane.YES_OPTION) savingOK = saveLearningUnit();
            if (returnValue == FLGOptionPane.NO_OPTION) invalidateLearningUnit();
            if (returnValue == FLGOptionPane.CANCEL_OPTION) savingOK = false;
        }
        if (learningUnitProperties != null && learningUnitProperties.getEditStatus().getCurrentlyEditedBy().equalsIgnoreCase(currentUserName))
            saveLearningUnitProperties("");
        return savingOK;
    }
    
    private void invalidateLearningUnit() {
        FSLLearningUnitEvent learningUnitEvent = FSLLearningUnitEvent.createLearningUnitInvalidatedEvent(currentLearningUnitId);
        fireLearningUnitEvent(learningUnitEvent);
    }
    
    public void fireLearningUnitEvent(FSLLearningUnitEvent event) {
        for (int i = 0; i < learningUnitListeners.size(); i++) {
            FSLLearningUnitListener learningUnitListener = (FSLLearningUnitListener)learningUnitListeners.get(i);
            switch (event.getEventType()) {
                case FSLLearningUnitEvent.LEARNING_UNIT_ACTIVATED:
                    learningUnitListener.learningUnitActivated(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNIT_CREATED:
                    learningUnitListener.learningUnitCreated(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNIT_REMOVED:
                    learningUnitListener.learningUnitRemoved(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNIT_INVALIDATED:
                    learningUnitListener.learningUnitInvalidated(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNIT_EDIT_MODE_CHANGED:
                    learningUnitListener.learningUnitEditModeChanged(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNIT_USER_VIEW_CHANGED:
                    learningUnitListener.learningUnitUserViewChanged(event);
                    break;
                case FSLLearningUnitEvent.LEARNING_UNITS_USER_DIRECTORY_CHANGED:
                    learningUnitListener.learningUnitsUserDirectoryChanged(event);
                    break;
                case FSLLearningUnitVetoableEvent.LEARNING_UNIT_ACTIVATING:
                    if (learningUnitListener instanceof FSLLearningUnitVetoableListener) {
                        FSLLearningUnitVetoableEvent vetoableEvent = (FSLLearningUnitVetoableEvent)event;
                        ((FSLLearningUnitVetoableListener)learningUnitListener).learningUnitActivating(vetoableEvent);
                        if (vetoableEvent.isVeto()) return;
                    }
                    break;
                case FSLLearningUnitVetoableEvent.LEARNING_UNIT_CREATING:
                    if (learningUnitListener instanceof FSLLearningUnitVetoableListener) {
                        FSLLearningUnitVetoableEvent vetoableEvent = (FSLLearningUnitVetoableEvent)event;
                        ((FSLLearningUnitVetoableListener)learningUnitListener).learningUnitCreating(vetoableEvent);
                        if (vetoableEvent.isVeto()) return;
                    }
                    break;
                case FSLLearningUnitVetoableEvent.LEARNING_UNITS_USER_DIRECTORY_CHANGING:
                    if (learningUnitListener instanceof FSLLearningUnitVetoableListener) {
                        FSLLearningUnitVetoableEvent vetoableEvent = (FSLLearningUnitVetoableEvent)event;
                        ((FSLLearningUnitVetoableListener)learningUnitListener).learningUnitsUserDirectoryChanging(vetoableEvent);
                        if (vetoableEvent.isVeto()) return;
                    }
                    break;
            }
        }
    }

    private void menuItemSelected(String menuItemId) {
        if (menuItemId.equals("menu.learningUnit.edit.title")) setEditMode(((JCheckBoxMenuItem)menuItems.get(menuItemId)).isSelected());
        if (menuItemId.equals("menu.learningUnit.linkChecker.title")) checkLinks();
        if (menuItemId.equals("menu.learningUnit.new.title")) showNewLearningUnitDialog(false);
        if (menuItemId.equals("menu.learningUnit.properties.title")) showPropertiesDialog(null);
        if (menuItemId.equals("menu.learningUnit.editStructure.title")) showEditStructureDialog();
        if (menuItemId.equals("menu.learningUnit.hoverStructure.title")) switchHoverStructurePanel();
        if (menuItemId.equals("menu.learningUnit.createAutomaticLinks.title")) showCreateAutomaticLinksDialog();
        if (menuItemId.equals("menu.learningUnit.save.title")) saveLearningUnit();
        if (menuItemId.equals("menu.learningUnit.saveAs.title")) saveAsLearningUnit();
        if (menuItemId.equals("menu.learningUnit.delete.title")) deleteLearningUnit(null);
        if (menuItemId.equals("menu.learningUnit.search.title")) showSearchDialog();
        if (menuItemId.equals("menu.learningUnit.reload.title")) reloadLearningUnitData();
        if (menuItemId.equals("menu.learningUnit.tourCreator.title")) showTourCreator();
        if (menuItemId.equals("menu.learningUnit.learningUnitsStructureTree.title")) openLearningUnitsStructureTreeDialog();
        /*** Jens Sieberg, 02.08.2006 ***/
        if (menuItemId.equals("menu.learningUnit.unitmap.title")) unitmap.showUnitmap();
        /*** Jens Sieberg, 02.08.2006 ***/
    }
    
    private void checkLinks() {
    	// ask user which links have to be checked
    	FSLLearningUnitLinkCheckerDialog linkCheckerDialog = new FSLLearningUnitLinkCheckerDialog();
    	boolean returnValue = linkCheckerDialog.showDialog();
    	if (returnValue==true) {
    		// invoke link checker
    		FSLLearningUnitLinkChecker linkChecker = new FSLLearningUnitLinkChecker(this, learningUnitViewsManager);
    		if(linkChecker.checkLinks(linkCheckerDialog.getLinkInOtherViews(), linkCheckerDialog.getLinkInOtherUnits())) { 
    			// dead links exist
    			linkChecker.deleteDeadLinks(); 
    		} else {
    			// no dead links
	    		FLGOptionPane.showConfirmDialog(internationalization.getString("linkChecker.optionPane.noDeadLinks.message"),
	    				internationalization.getString("linkChecker.optionPane.noDeadLinks.title"),
	    				FLGOptionPane.OK_OPTION, FLGOptionPane.PLAIN_MESSAGE);
    		}
    	}
    }
    
    private void openLearningUnitsStructureTreeDialog() {
        learningUnitsStructureTreePanel.init(learningUnitsDescriptor, FSLLearningUnitsManager.this);
        learningUnitsStructureTreePanel.openOptionPane();
    }
    
    public String[][] getViewManagerIdsAndTitlesForCurrentLearningUnit() {
        String[] currentLearningUnitViewIds = getLearningUnitViewManagersIdsOfLearningUnit(getActiveLearningUnitId());
        java.util.List supportingViewManagerIds = new ArrayList();
        java.util.List supportingViewManagerTitles = new ArrayList();
        for (int i = 0; i < currentLearningUnitViewIds.length; i++) {
            supportingViewManagerIds.add(currentLearningUnitViewIds[i]);
            supportingViewManagerTitles.add(learningUnitViewsManager.getLearningUnitViewManager(currentLearningUnitViewIds[i]).getLearningUnitViewManagerTitle());
        }
        String[][] supportingLearningUnitViewManagerIdsAndTitles = new String[supportingViewManagerIds.size()][2];
        for (int i = 0; i < supportingViewManagerIds.size(); i++) {
            supportingLearningUnitViewManagerIdsAndTitles[i][0] = supportingViewManagerIds.get(i).toString();
            supportingLearningUnitViewManagerIdsAndTitles[i][1] = supportingViewManagerTitles.get(i).toString();
        }
        return supportingLearningUnitViewManagerIdsAndTitles;
    }
    
    public String[][] getImportStructureSupportingViewManagerIdsAndTitles() {
        String[] currentLearningUnitViewIds = getLearningUnitViewManagersIdsOfLearningUnit(getActiveLearningUnitId());
        java.util.List supportingViewManagerIds = new ArrayList();
        java.util.List supportingViewManagerTitles = new ArrayList();
        for (int i = 0; i < currentLearningUnitViewIds.length; i++) {
            if (learningUnitViewsManager.getLearningUnitViewManager(currentLearningUnitViewIds[i]).supportsImportStructure()) {
                supportingViewManagerIds.add(currentLearningUnitViewIds[i]);
                supportingViewManagerTitles.add(learningUnitViewsManager.getLearningUnitViewManager(currentLearningUnitViewIds[i]).getLearningUnitViewManagerTitle());
            }
        }
        String[][] supportingLearningUnitViewManagerIdsAndTitles = new String[supportingViewManagerIds.size()][2];
        for (int i = 0; i < supportingViewManagerIds.size(); i++) {
            supportingLearningUnitViewManagerIdsAndTitles[i][0] = supportingViewManagerIds.get(i).toString();
            supportingLearningUnitViewManagerIdsAndTitles[i][1] = supportingViewManagerTitles.get(i).toString();
        }
        return supportingLearningUnitViewManagerIdsAndTitles;
    }
    
    public String[][] getAutomaticLinkSupportingViewManagersOfCurrentLearningUnit() {
        String[] currentLearningUnitViewIds = getLearningUnitViewManagersIdsOfLearningUnit(getActiveLearningUnitId());
        java.util.List supportingViewManagerIds = new ArrayList();
        java.util.List supportingViewManagerTitles = new ArrayList();
        for (int i = 0; i < currentLearningUnitViewIds.length; i++) {
            if (learningUnitViewsManager.getLearningUnitViewManager(currentLearningUnitViewIds[i]).supportsAutomaticLink()) {
                supportingViewManagerIds.add(currentLearningUnitViewIds[i]);
                supportingViewManagerTitles.add(learningUnitViewsManager.getLearningUnitViewManager(currentLearningUnitViewIds[i]).getLearningUnitViewManagerTitle());
            }
        }
        String[][] supportingLearningUnitViewManagerIdsAndTitles = new String[supportingViewManagerIds.size()][2];
        for (int i = 0; i < supportingViewManagerIds.size(); i++) {
            supportingLearningUnitViewManagerIdsAndTitles[i][0] = supportingViewManagerIds.get(i).toString();
            supportingLearningUnitViewManagerIdsAndTitles[i][1] = supportingViewManagerTitles.get(i).toString();
        }
        return supportingLearningUnitViewManagerIdsAndTitles;
    }
    
    private String[] getAutomaticLinkBackupDirectories() {
        java.util.List backupDirList = new java.util.ArrayList();
        String[][] suppportedViewManagerIdsAndTitles = getAutomaticLinkSupportingViewManagersOfCurrentLearningUnit();
        File viewManagerOriginalDirectory = learningUnitViewsManager.getLearningUnitViewManager(suppportedViewManagerIdsAndTitles[0][0]).getLearningUnitViewOriginalDataDirectory();
        File viewManagerUserDirectory = learningUnitViewsManager.getLearningUnitViewManager(suppportedViewManagerIdsAndTitles[0][0]).getLearningUnitViewUserDirectory();
        File originalDataDirectory = viewManagerOriginalDirectory.getParentFile();
        File userDataDirectory = viewManagerUserDirectory.getParentFile();
        File[] originalDataDirectories = originalDataDirectory.listFiles();
        File[] userDataDirectories = userDataDirectory.listFiles();
        for (int fileIx = 0; fileIx < originalDataDirectories.length; fileIx++) {
            if (originalDataDirectories[fileIx].isDirectory() && originalDataDirectories[fileIx].getName().indexOf("_") > 0) {
                backupDirList.add(originalDataDirectories[fileIx].getAbsolutePath());
            }
        }
        if (userDataDirectories != null) {
            for (int fileIx = 0; fileIx < userDataDirectories.length; fileIx++) {
                if (userDataDirectories[fileIx].isDirectory()
                && userDataDirectories[fileIx].getName().indexOf("_") > 0) {
                    backupDirList.add(userDataDirectories[fileIx].getAbsolutePath());
                }
            }
        }
        return (String[])backupDirList.toArray(new String[] { });
    }
    
    private void showCreateAutomaticLinksDialog() {
        createAutomaticLinksDialog = new FSLCreateAutomaticLinksDialog(
        getViewManagerIdsAndTitlesForCurrentLearningUnit(),
        getAutomaticLinkSupportingViewManagersOfCurrentLearningUnit(),
        getAutomaticLinkBackupDirectories(),
        userRoleIsAuthor,
        currentUserName);
        if (createAutomaticLinksDialog.showDialog()) {
            switch(createAutomaticLinksDialog.getTastState()) {
                case FSLCreateAutomaticLinksDialog.CREATE_LINK: {
                    // 1. identify link source view and target views
                    String linkTargetViewManagerId = createAutomaticLinksDialog.getLinkTargetViewManagarId();
                    final String[] linkSourceViewManagerIds = createAutomaticLinksDialog.getLinkSourceViewManagerIds();
                    
                    // 2. create element link target items:
                    //    - element names array
                    //    - link target objects array
                    FSLLearningUnitViewManager targetViewManager = learningUnitViewsManager.getLearningUnitViewManager(linkTargetViewManagerId);
                    String[] targetElementIds = targetViewManager.getLearningUnitViewElementsManager().getAllLearningUnitViewElementIds();
                    final String[] targetElementTitles = new String[targetElementIds.length];
                    final FSLLearningUnitViewElementLinkTarget[] linkTargets = new FSLLearningUnitViewElementLinkTarget[targetElementIds.length];
                    for (int i = 0; i < targetElementIds.length; i++) {
                        // get target element name (to be found in source views contents)
                        FSLLearningUnitViewElement targetElement = targetViewManager.getLearningUnitViewElementsManager().getLearningUnitViewElement(targetElementIds[i], false);
                        targetElementTitles[i] = targetElement.getTitle();
                        
                        // link targets (not "links"!)
                        FSLLearningUnitViewElementLinkTarget linkTarget = new FSLAutomaticCreatedLinkTarget();
                        linkTarget.setTargetLearningUnitId(currentLearningUnitId);
                        linkTarget.setTargetLearningUnitViewManagerId(linkTargetViewManagerId);
                        linkTarget.setTargetLearningUnitViewElementId(targetElementIds[i]);
                        linkTargets[i] = linkTarget;
                    }
                    // 3. create links in source view managers
                    new Thread(new Runnable() {
                        public void run() {
                            createLinksInSourceViews(linkSourceViewManagerIds, targetElementTitles, linkTargets);
                        }
                    }).start();
                    break;
                }
                case FSLCreateAutomaticLinksDialog.RECOVER_STATE: {
                    File recoveryDirectory = createAutomaticLinksDialog.getRecoveryStateDirectory();
                    if (recoveryDirectory != null && recoveryDirectory.exists()) {
                        if (FLGOptionPane.showConfirmDialog(
                        internationalization.getString("dialog.recoverState.message"),
                        internationalization.getString("dialog.recoverState.title"),
                        FLGOptionPane.OK_CANCEL_OPTION, FLGOptionPane.QUESTION_MESSAGE) == FLGOptionPane.APPROVE_OPTION) {
                            recoverState(createAutomaticLinksDialog);
                        }
                    }
                    break;
                }
            }
        }
    }
    
    private void recoverState(FSLCreateAutomaticLinksDialog dialog) {
        String fileSeparator = System.getProperty("file.separator");
        String directoryPath = dialog.getRecoveryStateDirectory().getAbsolutePath();
        String directoryName = directoryPath.substring(directoryPath.lastIndexOf(fileSeparator) + 1);
        String viewManagerDirectoryName = directoryName.substring(0, directoryName.indexOf("_"));
        String learningUnitDirectoryName = dialog.getRecoveryStateDirectory().getParent();
        
        // also here: back up state for later re-recovery
        String timeStamp = new Date().toString();
        timeStamp = FLGUtilities.replaceInString(timeStamp, ":", "-", true);
        timeStamp = FLGUtilities.replaceInString(timeStamp, " ", "_", true);
        File viewManagerDirectory = new File(learningUnitDirectoryName + fileSeparator + viewManagerDirectoryName);
        File targetDirectory = new File(learningUnitDirectoryName + fileSeparator + viewManagerDirectoryName + "_" + timeStamp);
        targetDirectory.mkdirs();
        FLGFileUtility.copyFileStructure(viewManagerDirectory, targetDirectory, true);
        
        // recover state
        FLGFileUtility.deleteDirectory(viewManagerDirectory);
        FLGFileUtility.copyFileStructure(dialog.getRecoveryStateDirectory(), viewManagerDirectory, true);
        FLGFileUtility.deleteDirectory(dialog.getRecoveryStateDirectory());
        
        saveLearningUnit();
        reloadLearningUnitData();
    }
    
    private void createLinksInSourceViews(String[] linkSourceViewManagerIds, String[] targetElementTitles,
    FSLLearningUnitViewElementLinkTarget[] linkTargets) {
        automaticLinksCreated = 0;
        // TBD: if selected, create new search index
        FSLLearningUnitViewManager[] sourceManagers = new FSLLearningUnitViewManager[linkSourceViewManagerIds.length];
        String[] viewManagerOriginalDirectories = new String[sourceManagers.length];
        String[] viewManagerUserDirectories = new String[sourceManagers.length];
        int noFiles = 0;
        for (int i = 0; i < sourceManagers.length; i++) {
            sourceManagers[i] = learningUnitViewsManager.getLearningUnitViewManager(linkSourceViewManagerIds[i]);
            viewManagerOriginalDirectories[i] = sourceManagers[i].getLearningUnitViewOriginalDataDirectory().getAbsolutePath();
            viewManagerUserDirectories[i] = sourceManagers[i].getLearningUnitViewUserDirectory().getAbsolutePath();
            noFiles += FLGFileUtility.fileCount(new File(viewManagerOriginalDirectories[i]))
            + FLGFileUtility.fileCount(new File(viewManagerUserDirectories[i]));
        }
        
        // lets go...
        FLGUIUtilities.startLongLastingOperation();
        
        // loop source managers,
        // loop target elements,
        // loop files to be linked to target elements
        // --> steps = noManagers x noTargetElements x noFiles
        int noSteps = noFiles + sourceManagers.length * targetElementTitles.length;
        int currentStep = 1;
        linksCreatingProgressDialog = new FLGImageProgressDialog(null, 0, noSteps, 0,
        getClass().getClassLoader().getResource("freestyleLearning/homeCore/images/fsl.gif"), (Color)UIManager.get("FSLColorBlue"),
        (Color)UIManager.get("FSLColorRed"));
        linksCreatingProgressDialog.setCursor(new Cursor(Cursor.WAIT_CURSOR));
        linksCreatingProgressDialog.setDisplayText(internationalization.getString("label.createBackups.text"));
        
        // backup files
        String timeStamp = new Date().toString();
        timeStamp = FLGUtilities.replaceInString(timeStamp, ":", "-", true);
        timeStamp = FLGUtilities.replaceInString(timeStamp, " ", "_", true);
        if (createAutomaticLinksDialog.getLinkAuthorFiles()) {
            for (int i = 0; i < viewManagerOriginalDirectories.length; i++) {
                File sourceDirectory = new File(viewManagerOriginalDirectories[i]);
                File targetDirectory = new File(viewManagerOriginalDirectories[i] + "_" + timeStamp);
                targetDirectory.mkdirs();
                FLGFileUtility.copyFileStructure(sourceDirectory, targetDirectory, true);
                linksCreatingProgressDialog.setBarValue(currentStep++);
            }
        }
        if (createAutomaticLinksDialog.getLinkUserFiles()) {
            for (int i = 0; i < viewManagerUserDirectories.length; i++) {
                File sourceDirectory = new File(viewManagerUserDirectories[i]);
                File targetDirectory = new File(viewManagerUserDirectories[i] + "_" + timeStamp);
                targetDirectory.mkdirs();
                FLGFileUtility.copyFileStructure(sourceDirectory, targetDirectory, true);
                linksCreatingProgressDialog.setBarValue(currentStep++);
            }
        }
        
        linksCreatingProgressDialog.setDisplayText(internationalization.getString("label.createLinks.text"));
        for (int i = 0; i < sourceManagers.length; i++) {
            String authorDirectory = "";
            String userDirectory = "";
            if (createAutomaticLinksDialog.getLinkAuthorFiles()) {
                authorDirectory = sourceManagers[i].getLearningUnitViewOriginalDataDirectory().getAbsolutePath();
            }
            if (createAutomaticLinksDialog.getLinkUserFiles()) {
                userDirectory = sourceManagers[i].getLearningUnitViewUserDirectory().getAbsolutePath();
            }
            searchDialog = new FSLSearchDialog(learningUnitViewsManager,
            sourceManagers[i].getLearningUnitViewOriginalDataDirectory().getAbsolutePath(),
            sourceManagers[i].getLearningUnitViewUserDirectory().getAbsolutePath());
            
            if (createAutomaticLinksDialog.getCreateIndex() && sourceManagers.length > 0) {
                searchDialog.createIndex(
                sourceManagers[i].getLearningUnitViewOriginalDataDirectory().getAbsolutePath(),
                sourceManagers[i].getLearningUnitViewUserDirectory().getAbsolutePath());
            }
            
            // loop element names in source views contents
            for (int ix = 0; ix < targetElementTitles.length; ix++) {
                linksCreatingProgressDialog.setBarValue(currentStep++);
                // create List containing all absoulte file names with hits of search string
                java.util.List filesFound = searchDialog.find(targetElementTitles[ix]);
                linksCreatingProgressDialog.setBarValue(currentStep++);
                for (int files = 0; files < filesFound.size(); files++) {
                    if (FLGFileUtility.getExtension(filesFound.get(files).toString()).equals("html")) {
                        // element name found, create links in this file
                        createLinksInFile(filesFound.get(files).toString(), targetElementTitles[ix], linkTargets[ix]);
                    }
                }
            }
        }
        // finshed, reload
        saveLearningUnit();
        reloadLearningUnitData();
        FLGUIUtilities.stopLongLastingOperation();
        linksCreatingProgressDialog.setCursor(new Cursor(Cursor.DEFAULT_CURSOR));
        linksCreatingProgressDialog.dispose();
        FLGOptionPane.showMessageDialog(internationalization.getString("dialog.linksCreated.message") + " " + automaticLinksCreated,
        internationalization.getString("dialog.linksCreated.title"),  FLGOptionPane.INFORMATION_MESSAGE);
    }
    
    /**
     *  This methods finds <code>linkElementContent</code>-String in a (html)file
     *  and creates a FSL link structure around it (if not already present).
     *  If already present, a FSL link target will be added.
     *  @param <code>fileName</code> absolute path string of (html) file
     *  @param <code>linkElementContent</code> the substring to be converted into a link
     *  @param <code>linkPrefix</code> string to be used as prefix to numbered links, e.g. l1, l2, ...
     *  @param <code>target</code> FSL link target to be added
     */
    private void createLinksInFile(String absoluteFileName, String elementTitle,
    FSLLearningUnitViewElementLinkTarget target) {
        String path = absoluteFileName.substring(0, absoluteFileName.lastIndexOf(System.getProperty("file.separator")));
        String subDirectoryPath = path.substring(path.lastIndexOf(System.getProperty("file.separator")) + 1)
        + absoluteFileName.substring(absoluteFileName.lastIndexOf(System.getProperty("file.separator")));
        Object[] currentElementData = searchDialog.getElementForSubDiectoryPath(subDirectoryPath);
        FSLLearningUnitViewElement currentElement = (FSLLearningUnitViewElement)currentElementData[1];
        FSLLearningUnitViewManager managerForCurrentElement = (FSLLearningUnitViewManager)currentElementData[2];
        
        if (currentElement != null && managerForCurrentElement != null) {
            // no link if target element is the current element!
            if (currentElement.getId().equals(target.getTargetLearningUnitViewElementId())
            && managerForCurrentElement.getLearningUnitViewManagerId().equals(target.getTargetLearningUnitViewManagerId())
            && currentLearningUnitId.equals(target.getTargetLearningUnitId())) {
                return;
            }
            
            try {
                File contentFile = new File(absoluteFileName);
                BufferedReader reader = new BufferedReader(new FileReader(absoluteFileName));
                StringBuffer fileContent = new StringBuffer();
                String line = new String();
                boolean linkCreated = false;
                // loop lines in file
                while((line = reader.readLine()) != null) {
                    StringBuffer lineBuffer = new StringBuffer(line + " ");
                    if (!(linkCreated && createAutomaticLinksDialog.getLinkingMethod() == FSLCreateAutomaticLinksDialog.LINK_ONE_PER_PAGE)) {
                        // loop characters in line (paragraph)
                        boolean createLinkInParagraph = true;
                        for (int i = 0; i < lineBuffer.length() - elementTitle.length(); i++) {
                            if (lineBuffer.substring(i).length() > elementTitle.length()) {
                                // compare substring to element title
                                // tbd: root words
                                if (lineBuffer.substring(i, 4 + i).equalsIgnoreCase("</p>")) {
                                    createLinkInParagraph = true;
                                }
                                if (createLinkInParagraph && lineBuffer.substring(i, elementTitle.length() + i).equalsIgnoreCase(elementTitle)
                                && !Character.isLetter(lineBuffer.charAt(i + elementTitle.length()))) {
                                    // currently within present link? get ID!
                                    String linkId = FLGUtilities.getHTMLLinkHref(lineBuffer.substring(0, i));
                                    
                                    // Add/update element link
                                    FSLLearningUnitViewElementLink link = null;
                                    if (linkId == null) {
                                        link = managerForCurrentElement.addLearningUnitViewElementLink(target, currentElement);
                                        automaticLinksCreated++;
                                        
                                        // modify HTML document
                                        String beginLinkTag = "<a href=\"" + link.getId() + "\">";
                                        
                                        lineBuffer.insert(i, beginLinkTag);
                                        lineBuffer.insert(i + elementTitle.length() + beginLinkTag.length(), "</a>");
                                        i = beginLinkTag.length() + i + elementTitle.length() + 4;
                                    }
                                    else if (linkId.startsWith("l")) {
                                        if (currentElement!= null && currentElement.getLearningUnitViewElementLinks() != null) {
                                            for (int linkIx = 0; linkIx < currentElement.getLearningUnitViewElementLinks().size(); linkIx++) {
                                                if (((FSLLearningUnitViewElementLink)(currentElement.getLearningUnitViewElementLinks().get(linkIx))).getId().equalsIgnoreCase(linkId)) {
                                                    if (targetExists(currentElement, linkId, target)) break;
                                                    managerForCurrentElement.addLearningUnitViewElementLinkTarget(linkId, target, currentElement);
                                                    automaticLinksCreated++;
                                                }
                                            }
                                        }
                                    }
                                    createLinkInParagraph = !(createAutomaticLinksDialog.getLinkingMethod() == FSLCreateAutomaticLinksDialog.LINK_ONE_PER_PARAGRAPH);
                                    linkCreated = true;
                                }
                            }
                        }
                    }
                    fileContent.append(new String(lineBuffer) + "\n");
                }
                BufferedWriter writer = new BufferedWriter(new FileWriter(absoluteFileName));
                writer.write(new String(fileContent));
                writer.flush();
                writer.close();
            }
            catch(Exception e) {
                e.printStackTrace();
                FLGOptionPane.showMessageDialog(e.getMessage(), "Error creating links", FLGOptionPane.ERROR_MESSAGE);
            }
        }
    }
    
    private boolean targetExists(FSLLearningUnitViewElement learningUnitViewElement,
    String linkId, FSLLearningUnitViewElementLinkTarget target) {
        FSLLearningUnitViewElementLink link = learningUnitViewElement.getLearningUnitViewElementLink(linkId);
        for (int i = 0; i < link.getLearningUnitViewElementLinkTargets().size(); i++) {
            FSLLearningUnitViewElementLinkTarget currentTarget = (FSLLearningUnitViewElementLinkTarget)link.getLearningUnitViewElementLinkTargets().get(i);
            if (currentTarget.getTargetLearningUnitId().equals(target.getTargetLearningUnitId())
            && currentTarget.getTargetLearningUnitViewElementId().equals(target.getTargetLearningUnitViewElementId())
            && currentTarget.getTargetLearningUnitViewManagerId().equals(target.getTargetLearningUnitViewManagerId())) {
                return true;
            }
        }
        return false;
    }
    
    class FSLAutomaticCreatedLink implements FSLLearningUnitViewElementLink {
        java.util.List linkTargets = new ArrayList();
        public String getId() {
            return "";
        }
        public void setId(String id) {
            
        }
        public java.util.List getLearningUnitViewElementLinkTargets() {
            return linkTargets;
        }
        public FSLLearningUnitViewElementLinkTarget addNewLearningUnitViewElementLinkTarget(
        String learningUnitId, String learningUnitViewElementManagerId, String learningUnitViewElementId) {
            return null;
        }
    }
    
    class FSLAutomaticCreatedLinkTarget implements FSLLearningUnitViewElementLinkTarget {
        private String targetLearningUnitId;
        private String targetViewManagerId;
        private String targetElementId;
        
        public String getTargetLearningUnitId() {
            return targetLearningUnitId;
        }
        
        public String getTargetLearningUnitViewElementId() {
            return targetElementId;
        }
        
        public String getTargetLearningUnitViewManagerId() {
            return targetViewManagerId;
        }
        
        public void setTargetLearningUnitId(String targetLearningUnitId) {
            this.targetLearningUnitId = targetLearningUnitId;
        }
        
        public void setTargetLearningUnitViewElementId(String targetLearningUnitViewElementId) {
            this.targetElementId = targetLearningUnitViewElementId;
        }
        
        public void setTargetLearningUnitViewManagerId(String targetLearningUnitViewManagerId) {
            this.targetViewManagerId = targetLearningUnitViewManagerId;
        }
        
        public String toString() {
            return "FSLLearningUnitViewElementLinkTarget << " + targetLearningUnitId + " - " + targetViewManagerId
            + " - " + targetElementId + " >>";
        }
    }
    
    private void switchHoverStructurePanel() {
        // remove structure panel from main frame
        // and place into separate "floating" window
        managerOfManagers.getMainFrame().switchHoverStructurePanel();
    }
    
    private boolean checkKeyHistory() {
        StringBuffer sb = new StringBuffer();
        for (int i = 0; i < keyHistory.length; i++) {
            sb.append(keyHistory[i]);
        }
        return sb.toString().equals("beerware");
    }
    
    private void displayBeerWareScreen() {
        FSLLicenseInfoPanel licenseInfoPanel = new FSLLicenseInfoPanel();
        (new FLGOptionPane(null, licenseInfoPanel,
        internationalization.getString("dialog.licenseInformationDialog.title"),
        FLGOptionPane.OK_OPTION, FLGOptionPane.PLAIN_MESSAGE, false)).setVisible(true);
    }
    
    private class FSLLicenseInfoPanel extends JPanel {
        FSLLicenseInfoPanel() {
            setLayout(new BorderLayout());
            JPanel labelPanel = new JPanel(new FLGColumnLayout());
            labelPanel.add(new JLabel(internationalization.getString("dialog.licenseInformationDialog.text1")), FLGColumnLayout.CENTEREND);
            labelPanel.add(new JLabel(internationalization.getString("dialog.licenseInformationDialog.text2")), FLGColumnLayout.CENTEREND);
            labelPanel.add(new JLabel(internationalization.getString("dialog.licenseInformationDialog.text3")), FLGColumnLayout.CENTEREND);
            
            ImageIcon icon = new ImageIcon(getClass().getClassLoader().getResource("freestyleLearning/homeCore/helpManager/images/BeerWare.gif"));
            JButton iconButton = new JButton(icon);
            iconButton.setPreferredSize(new Dimension(iconButton.getPreferredSize().width + 20, iconButton.getPreferredSize().height + 20));
            iconButton.setFocusPainted(false);
            iconButton.addActionListener(new ActionListener() {
                public void actionPerformed(ActionEvent e) {
                    JOptionPane.showMessageDialog(FSLLicenseInfoPanel.this, internationalization.getString("dialog.licenseInformationDialog.popup"));
                }
            });
            
            JPanel buttonPanel = new JPanel(new FlowLayout());
            buttonPanel.setBorder(BorderFactory.createEmptyBorder(10,10,10,10));
            buttonPanel.add(iconButton);
            
            add(labelPanel, BorderLayout.CENTER);
            add(buttonPanel, BorderLayout.SOUTH);
        }
    }
    
    // Carsten Fiedler modified 01.11.2005
    private void buildIndependentUI() {
        actions = new Hashtable();
        menuItems = new Hashtable();
        // create learning unit selection panel (textfield and button)
        learningUnitSelectionButton = new FLGEditToolBarButton(
        loadImage("selectLearningUnitButton.gif"), internationalization.getString("learningUnitSelectionButton.title"),
        new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                // open learningUnitSelectionOptionPane
                new Thread(new Runnable() {
                    public void run() {
                        openLearningUnitsStructureTreeDialog();
                    }
                }).start();
            }
        }
        );
        learningUnitSelectionButton.setEnabled(false);
        /**
         * learningUnitSelectionButton.addKeyListener(new KeyAdapter() {
         * public void keyPressed(KeyEvent e) {
         * for (int i = 0; i < keyHistory.length - 1; i++) {
         * keyHistory[i] = keyHistory[i+1];
         * }
         * keyHistory[keyHistory.length - 1] = e.getKeyChar();
         * if (checkKeyHistory()) displayBeerWareScreen();
         * }
         * });**/
        learningUnitSelectionPanel = new JPanel(new BorderLayout());
        learningUnitSelectionPanel.setBackground(Color.blue);
        learningUnitSelectionPanel.setOpaque(false);
        JPanel selectionButtonPanel = new JPanel(new BorderLayout());
        selectionButtonPanel.setBackground(new Color(172, 171, 190));
        selectionButtonPanel.setPreferredSize(new Dimension(30,30));
        selectionButtonPanel.add(learningUnitSelectionButton, BorderLayout.EAST);
        learningUnitSelectionPanel.add(selectionButtonPanel, BorderLayout.EAST);
        label_selectedLearningUnit = new JLabel();
        label_selectedLearningUnit.setBorder(new javax.swing.border.EmptyBorder(5,5,5,5));
        label_selectedLearningUnit.setBackground(new Color(240, 241, 245));
        label_selectedLearningUnit.setOpaque(true);
        label_selectedLearningUnit.setText("");
        label_selectedLearningUnit.setFont(new Font("SansSerif", Font.PLAIN, 16));
        learningUnitSelectionPanel.add(label_selectedLearningUnit);
        // Learning Unit Menu
        learningUnitMenu = new JMenu(internationalization.getString("menu.learningUnit.title"));
        learningUnitMenu.setMnemonic(internationalization.getString("menu.learningUnit.mnemonic").charAt(0));
        
        // Menu item "open"
        JMenuItem menuItem = createMenuItem("menu.learningUnit.learningUnitsStructureTree.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.learningUnitsStructureTree.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.learningUnitsStructureTree.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);
        
        // Menu item "new"
        menuItem = createMenuItem("menu.learningUnit.new.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.new.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.new.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);
        // Menu item "properties"
        menuItem = createMenuItem("menu.learningUnit.properties.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.properties.mnemonic").charAt(0));
        // menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.properties.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);
        // Sub Menu item "structure"
        JMenu menu_structure = new JMenu(internationalization.getString("menu.learningUnit.structure"));
        // menu item "edit structure"
        menuItem = createMenuItem("menu.learningUnit.editStructure.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.editStructure.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.editStructure.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        menu_structure.add(menuItem);
        
         // menu item "check links"
        menuItem = createMenuItem("menu.learningUnit.linkChecker.title");
        //menuItem.setMnemonic(internationalization.getString("").charAt(0));
        //menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);

       // create automatic links item
        menuItem = createMenuItem("menu.learningUnit.createAutomaticLinks.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.createAutomaticLinks.mnemonic").charAt(0));
        learningUnitMenu.add(menuItem);
        
        // menu item "hover"
        menuItem = createMenuItem("menu.learningUnit.hoverStructure.title", true);
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.hoverStructure.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.hoverStructure.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        menu_structure.add(menuItem);
        learningUnitMenu.add(menu_structure);
        // delete unit item
        learningUnitMenu.add(createMenuItem("menu.learningUnit.delete.title"));
        learningUnitMenu.addSeparator();
        // search item
        menuItem = createMenuItem("menu.learningUnit.search.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.search.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.search.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);
        // Edit Mode, Save and reload disabled for Presentation Version
        menuItem_edit = createMenuItem("menu.learningUnit.edit.title", true);
        menuItem_edit.setMnemonic(internationalization.getString("menu.learningUnit.edit.mnemonic").charAt(0));
        menuItem_edit.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.edit.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem_edit);
        // menu item "save"
        menuItem = createMenuItem("menu.learningUnit.save.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.save.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.save.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        learningUnitMenu.add(menuItem);
        // menu item "reload"
        menuItem = createMenuItem("menu.learningUnit.reload.title");
        // menuItem.setMnemonic(internationalization.getString("menu.learningUnit.reload.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke("F5"));
        learningUnitMenu.add(menuItem);
        // tour creator item
        menuItem = createMenuItem("menu.learningUnit.tourCreator.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.tourCreator.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.tourCreator.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        // temporary disabled
        learningUnitMenu.addSeparator();
        learningUnitMenu.add(menuItem);

        /*** Jens Sieberg, 02.08.2006 ***/
        //unitmap item
        menuItem = createMenuItem("menu.learningUnit.unitmap.title");
        menuItem.setMnemonic(internationalization.getString("menu.learningUnit.unitmap.mnemonic").charAt(0));
        menuItem.setAccelerator(KeyStroke.getKeyStroke(internationalization.getString("menu.learningUnit.unitmap.mnemonic").charAt(0), KeyEvent.CTRL_MASK));
        // temporary disabled
        learningUnitMenu.addSeparator();
        learningUnitMenu.add(menuItem);
        /*** Ende Jens Sieberg ***/
        
        mainFrameToolBarButtonsPanel = new JPanel(new FLGLeftToRightLayout(5));
        mainFrameToolBarButtonsPanel.setBorder(BorderFactory.createEmptyBorder(0, 0, 0, 0));
        mainFrameToolBarButtonsPanel.setOpaque(false);
        // Learning Unit Actions
        actions.put("learningUnitsStructureTree",
        new AbstractAction(internationalization.getString("menu.learningUnit.learningUnitsStructureTree.title")) {
            public void actionPerformed(ActionEvent e) {
                new Thread(new Runnable() {
                    public void run() {
                        openLearningUnitsStructureTreeDialog();
                    }
                }).start();
            }
        });
        
        actions.put("printAction",
        new AbstractAction(internationalization.getString("menu.learningUnit.print.title")) {
            public void actionPerformed(ActionEvent e) {
                printActiveElement();
            }
        });
        
        actions.put("displayWelcomeScreenAction",
        new AbstractAction(internationalization.getString("menu.file.welcomeScreen.display")) {
            public void actionPerformed(ActionEvent e) {
                showWelcomeScreen();
            }
        });
        
        /*** Carsten Fiedler, 29.08.2005 ***/
        actions.put("importAction",
        new AbstractAction(internationalization.getString("menu.learningUnit.import.title")) {
            public void actionPerformed(ActionEvent e) {
                importLearningUnit();
            }
        });
        actions.put("exportAction",
        new AbstractAction(internationalization.getString("menu.learningUnit.export.title")) {
            public void actionPerformed(ActionEvent e) {
                exportLearningUnit(learningUnitsDescriptor.getDescriptorById(currentLearningUnitId));
            }
        });
        /*** Carsten Fiedler finished ***/
        
        actions.put("onlineLinkAction",
        new AbstractAction(internationalization.getString("menu.learningUnit.onlineLink.title")) {
            public void actionPerformed(ActionEvent e) {
                openFSLWebSiteForCurrentUnit();
            }
        });
        actions.put("tourCreatorAction",
        new AbstractAction(internationalization.getString("menu.learningUnit.onlineLink.title")) {
            public void actionPerformed(ActionEvent e) {
                showTourCreator();
            }
        });
        // Learning Unit Action Buttons
        button_print = new FLGMainFrameToolBarButton(loadImage("print.gif"));
        button_print.setToolTipText(internationalization.getString("menu.learningUnit.print.title"));
        button_print.setAction((Action)actions.get("printAction"));
        
        button_onlineLink = new FLGMainFrameToolBarButton(loadImage("onlineLink.gif"));
        button_onlineLink.setToolTipText(internationalization.getString("menu.learningUnit.onlineLink.title"));
        button_onlineLink.setAction((Action)actions.get("onlineLinkAction"));
        
        button_tourCreator = new FLGMainFrameToolBarButton(loadImage("tourCreator.gif"));
        button_tourCreator.setToolTipText(internationalization.getString("menu.learningUnit.tourCreator.title"));
        button_tourCreator.setAction((Action)actions.get("tourCreatorAction"));
    }
    
    public FSLLearningUnitViewElementInteractionButton getTourCreatorCaptureButton() {
        return tourCreator.getCaptureButton();
    }
    
    public void updateMenuItems() {
        checkButtonsEnabled();
    }
    
    // Carsten Fiedler, 29.08.2005
    /**
     * public boolean getUserRoleIsAdministrator() {
     * return userRoleIsAdministrator;
     * }**/
    
    // Carsten Fiedler, 06.06.2005
    public boolean getUserRoleIsAuthor() {
        return userRoleIsAuthor;
    }
    
    // Carsten Fiedler modified 06.06.2005
    private void buildDependentUI() {
        // toolbar buttons
        mainFrameToolBarButtonsPanel.removeAll();
        // Default-ToolbarButtons:
        // Navigation Buttons
        FLGMainFrameToolBarButton[] buttons = learningUnitsNavigationHistoryManager.getMainFrameToolBarButtons();
        for (int i = 0; i < buttons.length; i++) mainFrameToolBarButtonsPanel.add(buttons[i]);
        // PrintButton
        checkButtonsEnabled();
        mainFrameToolBarButtonsPanel.add(button_print);
        // Tour Creator-Button
        // temporary disabled
        mainFrameToolBarButtonsPanel.add(button_tourCreator);
        // FSL-OnlineLink Button
        mainFrameToolBarButtonsPanel.add(button_onlineLink);
        // secondary activation buttons
        FSLLearningUnitViewSecondaryActivationButton[] learningUnitViewSecondaryButtons =
        learningUnitViewsManager.getLearningUnitViewsSecondaryButtons();
        if (learningUnitViewSecondaryButtons != null) {
            for (int i = 0; i < learningUnitViewSecondaryButtons.length; i++) {
                mainFrameToolBarButtonsPanel.add(learningUnitViewSecondaryButtons[i]);
            }
        }
        mainFrameToolBarButtonsPanel.revalidate();
        mainFrameToolBarButtonsPanel.repaint();
    }
    
    public Action getLearningUnitAction(String key) {
        return (Action)actions.get(key);
    }
    
    public void addLearningUnitAction(String key, Action action) {
        actions.put(key, action);
    }
    
    public void showSearchDialog() {
        Thread t = new Thread(
        new Runnable() {
            public void run() {
                int lastSeparatorIndex = currentLearningUnitPath.lastIndexOf("/");
                if (lastSeparatorIndex < 1) lastSeparatorIndex = currentLearningUnitPath.lastIndexOf(System.getProperty("file.separator"));
                String learningUnitDirectoryName =
                currentLearningUnitPath.substring(lastSeparatorIndex + 1, currentLearningUnitPath.length());
                if (searchDialog == null) {
                    searchDialog = new FSLSearchDialog(learningUnitViewsManager, currentLearningUnitPath,
                    learningUnitsUserDataDirectory + System.getProperty("file.separator") + learningUnitDirectoryName);
                }
                if (dataChanged) {
                    searchDialog.createIndex(currentLearningUnitPath,
                    learningUnitsUserDataDirectory + System.getProperty("file.separator") + learningUnitDirectoryName);
                    dataChanged = false;
                }
                if (searchDialog.showDialog()) {
                    String[] targetElement = searchDialog.getTargetElement();
                    if (targetElement != null) {
                        String managerId = targetElement[0];
                        String elementId = targetElement[1];
                        FSLLearningUnitViewManager manager =
                        learningUnitViewsManager.getLearningUnitViewManager(managerId);
                        learningUnitViewsManager.setActiveLearningUnitViewManager(manager, true);
                        manager.setActiveLearningUnitViewElementId(elementId, null);
                    }
                }
            }
        });
        t.start();
    }
    
    public void showTourCreator() {
        if(((FSLGuidedTourCreator)tourCreator).isInPresentationMode()) {
        	// open oresenter
        	((FSLGuidedTourCreator)tourCreator).openPresentationMode();
        } else {
        	// open list with tours
        	((FSLGuidedTourCreator)tourCreator).setVisible(true);
        }
        
    }
    
    public void setCurrentLearningUnitId(String id) {
    	currentLearningUnitId = id;
    }
    
    public void reloadLearningUnitData() {
        if (currentLearningUnitId != null) {
            String[] learningUnitViewManagerIds = getLearningUnitViewManagersIdsOfLearningUnit(currentLearningUnitId);
            for (int i = 0; i < learningUnitViewManagerIds.length; i++) {
                learningUnitViewsManager.getLearningUnitViewManager(learningUnitViewManagerIds[i]).reloadLearningUnitViewData();
            }
        }
    }
    
    /** Carsten Fiedler, 24.01.2005 **/
    public void printAllElements() {
        htmlCombiner = new FLGHTMLPagesCombiner(currentLearningUnitTitle);
        // get active LearningUnitViewManager
        FSLLearningUnitViewManager activeLearningUnitViewManager = learningUnitViewsManager.getActiveLearningUnitViewManager();
        // get active LearningUnitViewElementManager
        FSLLearningUnitViewElementsManager activeLearningUnitViewElementsManager = activeLearningUnitViewManager.getLearningUnitViewElementsManager();
        // get all Elements from learning Unit View
        String [] elementIds = activeLearningUnitViewElementsManager.getAllLearningUnitElementsByDepthFirstSearch();
        // get Learning Unit Path from active Learning Unit
        String learningUnitViewRelativePath = learningUnitViewsManager.getLearningUnitViewManagerDirectoryName(learningUnitViewsManager.getActiveLearningUnitViewManager().getLearningUnitViewManagerId());
        String activeLearningUnitPath = getLearningUnitPath() + System.getProperty("file.separator") + learningUnitViewRelativePath + System.getProperty("file.separator");      // tdb: verallgemeinern!
        try {
            for (int i = 0; i < elementIds.length; i++) {
                // get Html Content File Name by Id and check for folder
                String htmlContentFileName = activeLearningUnitViewManager.getHtmlContentFileName(elementIds[i]);
                if (htmlContentFileName==null) {
                    // add Folder Title
                    htmlCombiner.addTitleOfFolderElement(activeLearningUnitViewManager.getElementsTitleById(elementIds[i]));
                } else {
                    // use HTMLPagesCombiner to add element
                    htmlCombiner.addHtmlElement(activeLearningUnitPath + htmlContentFileName, activeLearningUnitViewManager.getElementsTitleById(elementIds[i]));
                }
            }
        }
        catch(Exception e) {
            System.out.println("An error occured while printing: " + e);
        }
        htmlCombiner.finalizeAndSetBase(activeLearningUnitPath);
    }
    
    public void printActiveElement() {
        if (learningUnitViewsManager.getActiveLearningUnitViewManager() == null
        || learningUnitViewsManager.getActiveLearningUnitViewManager().getActiveLearningUnitViewElementId() == null) {
            FLGOptionPane.showMessageDialog(internationalization.getString("dialog.selectPrintableElement.message"),
            internationalization.getString("dialog.selectPrintableElement.title"), FLGOptionPane.INFORMATION_MESSAGE);
            return;
        }
        final FSLLearningUnitViewManager activeLearningUnitViewManager = learningUnitViewsManager.getActiveLearningUnitViewManager();
        if (activeLearningUnitViewManager != null && activeLearningUnitViewManager.getPrintableComponent() != null) {
            String authors;
            FSLLearningUnitViewElementsManager activeLearningUnitViewElementsManager = activeLearningUnitViewManager.getLearningUnitViewElementsManager();
            if (activeLearningUnitViewElementsManager.isOriginalElementsOnly()
            || activeLearningUnitViewElementsManager.getLearningUnitViewUserElement(activeLearningUnitViewManager.getActiveLearningUnitViewElementId()) == null) {
                FSLLearningUnitDescriptor currentLearningUnitDescriptor =
                findLearningUnitDescriptorById(currentLearningUnitId);
                authors = currentLearningUnitDescriptor.getAuthors();
            }
            else {
                authors = "";
                printTitle = "User " + currentUserName;
            }
            printTitle = authors + ": " + getLearningUnitTitle(currentLearningUnitId) + " - " + activeLearningUnitViewManager.getLearningUnitViewManagerTitle();
            printMessage = "";
            boolean useDefaultPrinting = (activeLearningUnitViewManager.getDocumentRenderer() == null);
            printDialog = new FSLPrintDialog(printTitle, printMessage, activeLearningUnitViewManager.getPrintAllPossibility(), useDefaultPrinting);
            if (printDialog.showDialog(printTitle)) {
                if (printDialog.getPrintAllElementsIsSelected()) {
                    FLGUIUtilities.startLongLastingOperation();
                    new Thread() {
                        public void run() {
                            printAllElements();
                            FLGUIUtilities.stopLongLastingOperation();
                        }
                    }.start();
                }
                else {
                    // print active Element
                    printTitle = printDialog.getPrintTitle();
                    printMessage = printDialog.getPrintMessage();
                    printableComponent = activeLearningUnitViewManager.getPrintableComponent();
                    // check if view provides own printing implementation
                    if (activeLearningUnitViewManager.getDocumentRenderer() != null) {
                        FLGUIUtilities.startLongLastingOperation();
                        new Thread() {
                            public void run() {
                                Printable printable = activeLearningUnitViewManager.getDocumentRenderer();
                                PageFormat pFormat = new PageFormat();
                                PrinterJob pJob = PrinterJob.getPrinterJob();
                                
                                if (pJob.printDialog()) {
                                    pJob.setPrintable(printable, pFormat);
                                    try {
                                        pJob.print();
                                        FLGUIUtilities.stopLongLastingOperation();
                                    }
                                    catch (PrinterException printerException) {
                                        FLGUIUtilities.stopLongLastingOperation();
                                        System.out.println("Error Printing Document: " + printerException);
                                    }
                                }
                            }
                        }.start();
                    }
                    // otherwise use default printing implementation
                    else {
                        FLGUIUtilities.startLongLastingOperation();
                        new Thread() {
                            public void run() {
                                FLGPrintExt.printComponent(printableComponent, "", printTitle, printMessage, printDialog.isScaleToFit());
                                FLGUIUtilities.stopLongLastingOperation();
                            }
                        }.start();
                    }
                }
                
            }
        }
    }
    
    // Carsten Fiedler, 29.08.2005
    private void checkButtonsEnabled() {
    	getAction("menu.learningUnit.linkChecker.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.new.title").setEnabled(userRoleIsAuthor);
        getAction("menu.learningUnit.edit.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.properties.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.editStructure.title").setEnabled(userRoleIsAuthor && currentLearningUnitId != null);
        getAction("menu.learningUnit.save.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.hoverStructure.title").setEnabled(true);
        getAction("menu.learningUnit.createAutomaticLinks.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.search.title").setEnabled(currentLearningUnitId != null);
        getAction("menu.learningUnit.reload.title").setEnabled(!editMode && learningUnitViewsManager.getActiveLearningUnitViewManager() != null);
        getAction("menu.learningUnit.delete.title").setEnabled(userRoleIsAuthor && (currentLearningUnitId != null));
        getAction("menu.learningUnit.learningUnitsStructureTree.title").setEnabled(currentUserName != null);
        getAction("menu.learningUnit.tourCreator.title").setEnabled(currentUserName != null);
        getAction("tourCreatorAction").setEnabled(currentUserName != null);
        getAction("displayWelcomeScreenAction").setEnabled(currentUserName != null);
        boolean printEnabled = currentLearningUnitId != null;
        boolean exportEnabled = currentLearningUnitId != null;
        boolean searchEnabled = currentLearningUnitId != null;
        Action printAction = (Action)actions.get("printAction");
        if (printAction != null) {
            printAction.setEnabled(printEnabled);
        }
        
        Action exportAction = (Action)actions.get("exportAction");
        if (exportAction != null) {
            exportAction.setEnabled(printEnabled);
        }
        
        if (currentLearningUnitId == null)
            button_onlineLink.setToolTipText(internationalization.getString("menu.learningUnit.onlineLink.title"));
        else
            button_onlineLink.setToolTipText(internationalization.getString("menu.learningUnit.onlineLU.title"));
    }
    
    // TO DO: Methode fr OpenUSS-Login berarbeiten
    private void openFSLWebSiteForCurrentUnit() {
    	
    	System.out.println("openFSLWebSiteForCurrentUnit invoked...");
    	
    	
        String url_webSiteForCurrentLearningUnit = "http://www.freestyle-learning.de/index.html";
        if (currentLearningUnitId != null) {
            String learningUnitEnrollmentId = getLearningUnitEnrollmentId(currentLearningUnitId);
            String openUssServerName = getLearningUnitOpenUssServerName(currentLearningUnitId);
            if (learningUnitEnrollmentId != null) {
                String openUssUserRole = "Student";
                if (userRoleIsAuthor) openUssUserRole = "Assistant";
                url_webSiteForCurrentLearningUnit = "http://" + openUssServerName +
                "/extension/directaccess/semester/SemesterPageLinkAction.po"
                + "?Usertype=" + openUssUserRole
                + "&Username=" + currentUserName
                + "&Password=" + currentUserPassword
                + "&SemesterId=" + learningUnitEnrollmentId;
            }
        }
        
        FLGPlatformSpecifics.startExternalApplication(url_webSiteForCurrentLearningUnit);
        
    }
    
    private Image loadImage(String imageFileName) {
        return FLGImageUtility.loadImageAndWait(getClass().getClassLoader().getResource("freestyleLearning/homeCore/learningUnitsManager/images/" +
        imageFileName));
    }
    
    private int getIndexOfCurrentLearningUnit() {
        int index = 0;
        for (index = 0; index < learningUnitsDescriptor.getLearningUnitsDescriptors().size(); index++) {
            String learningUnitId = ((FSLLearningUnitDescriptor)learningUnitsDescriptor.getLearningUnitsDescriptors().get(index)).getId();
            if (learningUnitId.equals(currentLearningUnitId)) return index;
        }
        return index;
    }
    
    private Action getAction(String id) {
        return (Action)actions.get(id);
    }
    
    private JMenuItem createMenuItem(String menuItemId) {
        return createMenuItem(menuItemId, false);
    }
    
    private JMenuItem createMenuItem(String menuItemId, boolean asCheckBoxMenuItem) {
        Action action = new AbstractAction(internationalization.getString(menuItemId)) {
            public void actionPerformed(ActionEvent e) {
                menuItemSelected(((AbstractButton)e.getSource()).getActionCommand());
            }
        };
        actions.put(menuItemId, action);
        JMenuItem menuItem;
        if (asCheckBoxMenuItem) menuItem = new JCheckBoxMenuItem(action);
        else {
            menuItem = new JMenuItem(action);
        }
        menuItem.setActionCommand(menuItemId);
        menuItems.put(menuItemId, menuItem);
        return menuItem;
    }
    
    private FSLLearningUnitDescriptor findLearningUnitDescriptorById(String learningUnitId) {
        java.util.List learningUnitDescriptorList = learningUnitsDescriptor.getLearningUnitsDescriptors();
        for (int i = 0; i < learningUnitDescriptorList.size(); i++) {
            FSLLearningUnitDescriptor learningUnitDescriptor = (FSLLearningUnitDescriptor)learningUnitDescriptorList.get(i);
            if (learningUnitDescriptor.getId().equals(learningUnitId)) {
                return learningUnitDescriptor;
            }
        }
        return null;
    }
    
    private FSLLearningUnitsDescriptor loadLearningUnitsDescriptor(File learningUnitsDescriptorFile) {
        return loadLearningUnitsDescriptor(learningUnitsDescriptorFile, true);
    }
    
    public FSLLearningUnitsDescriptor loadLearningUnitsDescriptor(File learningUnitsDescriptorFile, boolean recoverySupported) {
        FSLLearningUnitsDescriptor learningUnitsDescriptor = null;
        Dispatcher dispatcher = LearningUnitsDescriptor.newDispatcher();
        dispatcher.register(LearningUnitsDescriptor.class, FSLLearningUnitsDescriptor.class);
        dispatcher.register(LearningUnitDescriptor.class, FSLLearningUnitDescriptor.class);
        FileInputStream learningUnitsDescriptorFileInputStream = null;
        File backUpFile = null;
        try {
            learningUnitsDescriptorFileInputStream = new FileInputStream(learningUnitsDescriptorFile);
            learningUnitsDescriptor = (FSLLearningUnitsDescriptor)dispatcher.unmarshal(learningUnitsDescriptorFileInputStream);
            learningUnitsDescriptorFileInputStream.close();
            // create recovery version of descriptor file
            if (recoverySupported) {
                backUpFile = new File(learningUnitsDescriptorFile.getAbsolutePath() + "_recovery");
                FLGFileUtility.copyFile(learningUnitsDescriptorFile, backUpFile);
            }
        }
        catch (IOException ioe) {
            System.out.println("FSLLearningUnitsManager.loadLearningUnitsDescriptor(): " + ioe);
            String message = internationalization.getString("dialog.message.couldNotCreateBackupLUDescriptor1") + "\n" +
            backUpFile.getPath() + "\n\n" + internationalization.getString("dialog.message.couldNotCreateBackupLUDescriptor2");
        }
        catch (Exception e) {
            System.out.println("FSLLearningUnitsManager.loadLearningUnitsDescriptor(): " + e);
            if (recoverySupported) {
                String message = internationalization.getString("dialog.message.errorParsingLUDescriptor1") + "\n" +
                learningUnitsDescriptorFile.getPath() + "\n\n" +
                internationalization.getString("dialog.message.errorParsingLUDescriptor2") + "\n\n" +
                internationalization.getString("dialog.message.errorParsingLUDescriptor3");
                System.out.println(message);
                if (JOptionPane.showConfirmDialog(null, message, "Bla", JOptionPane.YES_NO_OPTION) == JOptionPane.YES_OPTION) {
                    backUpFile = new File(learningUnitsDescriptorFile.getAbsolutePath() + "_recovery");
                    if (backUpFile.exists()) {
                        File corruptFile = new File(learningUnitsDescriptorFile.getAbsolutePath() + "_unreadable_by_FSL");
                        FLGFileUtility.copy(learningUnitsDescriptorFile, corruptFile);
                        FLGFileUtility.copy(backUpFile, learningUnitsDescriptorFile);
                        try {
                            learningUnitsDescriptorFileInputStream = new FileInputStream(backUpFile);
                            learningUnitsDescriptor = (FSLLearningUnitsDescriptor)dispatcher.unmarshal(learningUnitsDescriptorFileInputStream);
                            learningUnitsDescriptorFileInputStream.close();
                        }
                        catch (Exception ex) {
                            learningUnitsDescriptor = new FSLLearningUnitsDescriptor();
                        }
                    }
                    else {
                        System.out.println("no backup file");
                        learningUnitsDescriptor = new FSLLearningUnitsDescriptor();
                    }
                }
                else {
                    learningUnitsDescriptor = new FSLLearningUnitsDescriptor();
                }
            }
        }
        return learningUnitsDescriptor;
    }
    
    public void setDisplayWelcomeScreen(boolean displayWelcomeScreenEnabled) {
        boolean automaticSelectionEnabled = managerOfManagers.getUsersManager().getAutomaticSelectionEnabled();
        boolean rememberFrameStatusEnabled = managerOfManagers.getUsersManager().getRememberFrameStatusEnabled();
        FSLProgramConfigurationEvent event = FSLProgramConfigurationEvent.createFSLConfigurationChangedEvent(
        automaticSelectionEnabled, displayWelcomeScreenEnabled, rememberFrameStatusEnabled);
        managerOfManagers.getProgramConfigurationManager().fireProgramConfigurationEvent(event);
    }
    
    public void showWelcomeScreen() {
        try {
            if (welcomeScreen == null) {
                welcomeScreen = new FSLWelcomeScreen(FLGUIUtilities.getMainFrame(), FSLLearningUnitsManager.this,
                managerOfManagers.getProgramConfigurationManager().getLearningUnitsDirectory());
            }
            welcomeScreen.setDisplayOnStartup(true);
            welcomeScreen.setVisible(true);
        }
        catch(Exception e) {
            FLGOptionPane.showMessageDialog(
            internationalization.getString("dialog.errorDisplayWelcomeScreen.message"),
            internationalization.getString("dialog.errorDisplayWelcomeScreen.title"),
            FLGOptionPane.INFORMATION_MESSAGE);
        }
    }
    
    public void followLearningUnitViewElementLink(String unitId, String viewManagerId, String viewElementId) {
        final String targetLearningUnitId = unitId;
        final String targetLearningUnitViewManagerId = viewManagerId;
        final String targetLearningUnitViewElementId = viewElementId;
        if (!targetLearningUnitId.equals(currentLearningUnitId)) {
            (new Thread() {
                public void run() {
                    setActiveLearningUnit(targetLearningUnitId);
                    FSLLearningUnitViewManager targetLearningUnitViewManager = learningUnitViewsManager.getLearningUnitViewManager(targetLearningUnitViewManagerId);
                    learningUnitViewsManager.setActiveLearningUnitViewManager(targetLearningUnitViewManager, true);
                    targetLearningUnitViewManager.setActiveLearningUnitViewElementId(targetLearningUnitViewElementId, null);
                }
            }).start();
        }
        else {
            FSLLearningUnitViewManager targetLearningUnitViewManager = learningUnitViewsManager.getLearningUnitViewManager(targetLearningUnitViewManagerId);
            learningUnitViewsManager.setActiveLearningUnitViewManager(targetLearningUnitViewManager, true);
            targetLearningUnitViewManager.setActiveLearningUnitViewElementId(targetLearningUnitViewElementId, null);
        }
    }
    
    public void requestEditMode(boolean enableEditMode) {
        setEditMode(enableEditMode);
    }
    
    class FSLLearningUnitsManager_TourCreatorInteractor implements FSLTourCreatorInteractor {
        public void displayFLG2TourCreatorElementInformation(FLG2TourCreatorElementInformation elementInformation) {
            if (elementInformation != null) {
                followLearningUnitViewElementLink(elementInformation.getTargetLearningUnitId(),
                elementInformation.getTargetLearningUnitViewManagerId(), elementInformation.getTargetLearningUnitViewElementId());
            }
        }
        
        public FLG2TourCreatorElementInformation getCurrentFLG2TourCreatorElementInformation() {
            if (learningUnitViewsManager.getActiveLearningUnitViewManager() != null) {
                FLG2TourCreatorStandardElementInformation information = new FLG2TourCreatorStandardElementInformation();
                String targetElementId = learningUnitViewsManager.getActiveLearningUnitViewManager().getActiveLearningUnitViewElementId();
                information.setTargetLearningUnitId(currentLearningUnitId);
                information.setTargetLearningUnitViewManagerId(learningUnitViewsManager.getActiveLearningUnitViewManager().getLearningUnitViewManagerId());
                information.setTargetLearningUnitViewElementId(targetElementId);
                information.setTargetLearningUnitName(currentLearningUnitTitle);
                information.setTargetLearningUnitViewManagerName(learningUnitViewsManager.getActiveLearningUnitViewManager().getLearningUnitViewManagerTitle());
                information.setTargetLearningUnitViewElementName(learningUnitViewsManager.getActiveLearningUnitViewManager().getLearningUnitViewElementsManager().getLearningUnitViewElement(targetElementId, false).getTitle());
                information.setElementImage(getElementImage());
                return information;
            }
            return null;
        }
        
        private Image getElementImage() {
            BufferedImage receivedImage = FLGUIUtilities.captureScreen();
            int height = receivedImage.getHeight(null);
            int width  = receivedImage.getWidth(null);
            double scaleFactor = 256.0 /Math.max(height, width);
            return receivedImage.getScaledInstance((int)(width*scaleFactor), (int)(height*scaleFactor), Image.SCALE_SMOOTH);
        }
    }
    
    class FSLLearningUnitsManager_TourCreatorLinkTarget implements FSLLearningUnitViewElementLinkTarget {
        private String learningUnitId;
        private String learningUnitViewManagerId;
        private String learningUnitViewElementId;
        
        public String getTargetLearningUnitId() {
            return learningUnitId;
        }
        
        public String getTargetLearningUnitViewManagerId() {
            return learningUnitViewManagerId;
        }
        
        public String getTargetLearningUnitViewElementId() {
            return learningUnitViewElementId;
        }
        
        public void setTargetLearningUnitId(String targetLearningUnitId) {
            learningUnitId = targetLearningUnitId;
        }
        
        public void setTargetLearningUnitViewManagerId(String targetLarningUnitViewManagerId) {
            learningUnitViewManagerId = targetLarningUnitViewManagerId;
        }
        
        public void setTargetLearningUnitViewElementId(String targetLarningUnitViewElementId) {
            learningUnitViewElementId = targetLarningUnitViewElementId;
        }
    }
    
    class FSLLearningUnitsManager_ProgramConfigurationAdapter implements FSLProgramConfigurationListener {
        public void configurationChanged(FSLProgramConfigurationEvent event) {
            learningUnitViewsManager.learningUnitViewManagersBaseFontsSizesChanged();
        }
    }
    
    
    class FSLLearningUnitsManager_UserAdapter implements FSLUserListener {
        public void userChanging(FSLUserVetoableEvent userEvent) {
            FSLLearningUnitVetoableEvent learningUnitEvent =
            FSLLearningUnitVetoableEvent.createLearningUnitsUserDirectoryChangingEvent();
            boolean veto = !askUserForSavingUnchangedData();
            if (!veto) {
                fireLearningUnitEvent(learningUnitEvent);
                veto = learningUnitEvent.isVeto();
            }
            if (veto) userEvent.setVeto();
        }
        
        // Carsten Fiedler, 29.08.2005
        public void userChanged(FSLUserEvent userEvent) {
            currentUserName = (userEvent.getUserName().substring(0, 1)).toUpperCase() +
            userEvent.getUserName().substring(1, userEvent.getUserName().length());
            currentUserPassword = userEvent.getUserPassword();
            learningUnitViewsManager.setCurrentUserData(currentUserName, currentUserPassword);
            userRoleIsAuthor = userEvent.getUserRole().equals(FSLUserEvent.AUTHOR_ROLE);
            //userRoleIsAdministrator = userEvent.getUserRole().equals(FSLUserEvent.ADMINISTRATOR_ROLE);
            userSelected = true;
            currentLearningUnitId = null;
            currentLearningUnitTitle = null;
            currentLearningUnitPath = null;
            fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitActivatedEvent(currentLearningUnitId,
            currentLearningUnitTitle, currentLearningUnitPath));
            learningUnitsUserDataDirectory = new File(userEvent.getUserDirectory(), "learningUnits");
            FSLLearningUnitEvent learningUnitEvent =
            FSLLearningUnitEvent.createLearningUnitsUserDirectoryChangedEvent(learningUnitsUserDataDirectory);
            fireLearningUnitEvent(learningUnitEvent);
            learningUnitEvent = FSLLearningUnitEvent.createLearningUnitUserViewChangedEvent(userRoleIsAuthor);
            fireLearningUnitEvent(learningUnitEvent);
            buildDependentUI();
            learningUnitViewsManager.learningUnitViewManagersBaseFontsSizesChanged();
            learningUnitSelectionButton.setEnabled(true);
            label_selectedLearningUnit.setText(internationalization.getString("learningUnitSelectionButton.init.label_selectedLearningUnit"));
            label_selectedLearningUnit.setEnabled(true);
            if (userEvent.isDisplayWelcomeScreenEnabled()) {
                showWelcomeScreen();
            }
        }
        
        // Carsten Fiedler, 29.08.2005
        public void userLogout(FSLUserEvent userEvent) {
            currentUserName = null;
            currentUserPassword = null;
            learningUnitViewsManager.setCurrentUserData(currentUserName, currentUserPassword);
            userRoleIsAuthor = false;
            //userRoleIsAdministrator = false;
            userSelected = false;
            currentLearningUnitId = null;
            currentLearningUnitTitle = null;
            currentLearningUnitPath = null;
            fireLearningUnitEvent(FSLLearningUnitEvent.createLearningUnitActivatedEvent(currentLearningUnitId,
            currentLearningUnitTitle, currentLearningUnitPath));
            learningUnitsUserDataDirectory = null;
            FSLLearningUnitEvent learningUnitEvent =
            FSLLearningUnitEvent.createLearningUnitsUserDirectoryChangedEvent(learningUnitsUserDataDirectory);
            fireLearningUnitEvent(learningUnitEvent);
            learningUnitEvent = FSLLearningUnitEvent.createLearningUnitUserViewChangedEvent(userRoleIsAuthor);
            fireLearningUnitEvent(learningUnitEvent);
            buildDependentUI();
            learningUnitSelectionButton.setEnabled(false);
            label_selectedLearningUnit.setText("");
            label_selectedLearningUnit.setEnabled(false);
        }
        
        // Carsten Fiedler, 29.08.2005
        public void userRoleChanged(FSLUserEvent userEvent) {
            userRoleIsAuthor = userEvent.getUserRole().equals(FSLUserEvent.AUTHOR_ROLE);
            //userRoleIsAdministrator = userEvent.getUserRole().equals(FSLUserEvent.ADMINISTRATOR_ROLE);
            saveLearningUnitProperties(currentUserName);
            FSLLearningUnitEvent learningUnitEvent =
            FSLLearningUnitEvent.createLearningUnitUserViewChangedEvent(userRoleIsAuthor);
            fireLearningUnitEvent(learningUnitEvent);
            buildDependentUI();
        }
    }
    
}
