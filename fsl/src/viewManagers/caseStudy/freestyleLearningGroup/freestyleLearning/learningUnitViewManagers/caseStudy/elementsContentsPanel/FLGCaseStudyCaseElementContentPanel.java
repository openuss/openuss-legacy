/* Generated by Freestyle Learning Group */

package freestyleLearningGroup.freestyleLearning.learningUnitViewManagers.caseStudy.elementsContentsPanel;

import java.awt.BorderLayout;
import java.io.File;
import java.util.*;
import javax.swing.BorderFactory;
import javax.swing.JComponent;
import javax.swing.JPanel;
import javax.swing.text.html.HTMLDocument;

import freestyleLearning.learningUnitViewAPI.FSLLearningUnitViewElement;
import freestyleLearning.learningUnitViewAPI.FSLLearningUnitViewManager;
import freestyleLearning.learningUnitViewAPI.elementsContentsPanel.FSLAbstractLearningUnitViewElementContentPanel;
import freestyleLearning.learningUnitViewAPI.events.learningUnitEvent.FSLLearningUnitEvent;
import freestyleLearning.learningUnitViewAPI.events.learningUnitEvent.FSLLearningUnitEventGenerator;
import freestyleLearning.learningUnitViewAPI.events.learningUnitEvent.FSLLearningUnitVetoableAdapter;
import freestyleLearning.learningUnitViewAPI.events.learningUnitViewEvent.FSLLearningUnitViewEvent;
import freestyleLearning.learningUnitViewAPI.events.learningUnitViewEvent.FSLLearningUnitViewVetoableAdapter;
import freestyleLearning.learningUnitViewAPI.util.FSLLearningUnitViewUtilities;
import freestyleLearningGroup.freestyleLearning.learningUnitViewManagers.caseStudy.data.xmlBindingSubclasses.FLGCaseStudyElement;
import freestyleLearningGroup.independent.gui.FLGHtmlPane;
import freestyleLearningGroup.independent.gui.FLGHtmlPaneEditButtonsFactory;
import freestyleLearningGroup.independent.gui.FLGHtmlUtilities;
import freestyleLearningGroup.independent.gui.FLGScrollPane;
import freestyleLearningGroup.independent.util.FLGFileUtility;

public class FLGCaseStudyCaseElementContentPanel extends FSLAbstractLearningUnitViewElementContentPanel {
    private FLGScrollPane scrollPane;
    private FLGHtmlPane elementContentHtmlPane;
    private FLGHtmlPane elementTitleHtmlPane;
    private JPanel scrollPaneView;
    private boolean active;
    private JComponent[] editToolBarComponents;

    public void init(FSLLearningUnitViewManager learningUnitViewManager,
        FSLLearningUnitEventGenerator learningUnitEventGenerator, boolean editMode) {
            super.init(learningUnitViewManager, learningUnitEventGenerator, editMode);
            learningUnitEventGenerator.addLearningUnitListener(new FLGCaseStudyElementContentPanel_LearningUnitAdapter());
            learningUnitViewManager.addLearningUnitViewListener(new FLGCaseStudyElementContentPanel_LearningUnitViewAdapter());
    }

    protected java.awt.Component getPrintableComponent() {
        JPanel scrollPaneView = new JPanel(new BorderLayout());
        FLGHtmlPane printableContentHtmlPane = new FLGHtmlPane();
        FLGHtmlPane printableTitleHtmlPane = new FLGHtmlPane();
        printableTitleHtmlPane.setEditable(false);
        printableTitleHtmlPane.setSize(elementTitleHtmlPane.getPreferredSize());
        printableContentHtmlPane.setBase(elementContentHtmlPane.getBase());
        printableContentHtmlPane.setEditable(false);
        printableContentHtmlPane.setSize(elementContentHtmlPane.getPreferredSize());
        FSLLearningUnitViewElement viewElement = learningUnitViewElementsManager.getLearningUnitViewElement(learningUnitViewElementId, false);
        printableTitleHtmlPane.setText("<html><body><h3>" + viewElement.getTitle() + "</h3></body></html>");
        printableContentHtmlPane.setText(FLGHtmlUtilities.createPrintableHtmlText(elementContentHtmlPane.getText()));
        scrollPaneView.add(printableTitleHtmlPane, BorderLayout.NORTH);
        scrollPaneView.add(printableContentHtmlPane, BorderLayout.CENTER);
        scrollPaneView.setSize(this.scrollPaneView.getPreferredSize());
        return scrollPaneView;
    }

    public boolean isModifiedByUserInput() {
        return elementContentHtmlPane.isModifiedByUserInput();
    }

    public void saveUserChanges() {
        File htmlFile;
        FLGCaseStudyElement learningUnitViewElement =
            (FLGCaseStudyElement)learningUnitViewElementsManager.getLearningUnitViewElement(learningUnitViewElementId, true);
        learningUnitViewElement.setLastModificationDate(String.valueOf(new Date().getTime()));
        if (learningUnitViewElement.getHtmlFileName() == null) {
            htmlFile = learningUnitViewElementsManager.createNewFileForElementsExternalData(FLGCaseStudyElement.ELEMENT_TYPE_CASE,
                ".html", learningUnitViewElementId);
            learningUnitViewElement.setHtmlFileName(htmlFile.getName());
        }
        else {
            String relativeFileName = learningUnitViewElementsManager.getRelativeFileNameVersionForWriting(learningUnitViewElement.getHtmlFileName(),
                learningUnitViewElement, FLGCaseStudyElement.ELEMENT_TYPE_CASE, ".html");
            htmlFile = learningUnitViewElementsManager.resolveRelativeFileName(relativeFileName, learningUnitViewElement);
            learningUnitViewElement.setHtmlFileName(relativeFileName);
        }
        FLGFileUtility.writeStringIntoFile(elementContentHtmlPane.getText(), htmlFile);
    }

    public void updateUI() {
        super.updateUI();
        if (elementContentHtmlPane != null)
            FSLLearningUnitViewUtilities.updateHtmlPaneUI(elementContentHtmlPane);
        if (elementTitleHtmlPane != null)
            FSLLearningUnitViewUtilities.updateHtmlPaneUI(elementTitleHtmlPane);
    }

    protected void setActiveLearningUnitViewElementPanel(boolean active) {
        super.setActiveLearningUnitViewElementPanel(active);
        elementContentHtmlPane.setEditable(editMode && activeLearningUnitViewElementPanel);
    }

    protected JComponent[] getEditToolBarComponents() {
        return editToolBarComponents;
    }

    protected void buildIndependentUI() {
        setLayout(new java.awt.BorderLayout());
        elementContentHtmlPane = new FLGHtmlPane();
        elementTitleHtmlPane = new FLGHtmlPane();
        elementContentHtmlPane.setEditable(editMode);
//        elementTitleHtmlPane.setEnabled(false);
        elementTitleHtmlPane.setEditable(false);
        elementContentHtmlPane.addHyperlinkListener(new FSLLearningUnitViewElementContentPanel_HyperlinkAdapter());
        elementContentHtmlPane.setSupportWebSearches(true);
        scrollPaneView = new JPanel(new BorderLayout());
        scrollPaneView.add(elementTitleHtmlPane, BorderLayout.NORTH);
        scrollPaneView.add(elementContentHtmlPane, BorderLayout.CENTER);
        scrollPane = new FLGScrollPane(scrollPaneView);
        scrollPane.setBorder(BorderFactory.createEmptyBorder(0, 0, 0, 0));
        add(scrollPane);
        // toolbar
        FLGHtmlPaneEditButtonsFactory.FLGFileCreator fileCreator = new FLGHtmlPaneEditButtonsFactory.FLGFileCreator() {
            public File createFile(String fileExtension) {
                return learningUnitViewElementsManager.createNewFileForElementsExternalData("image", fileExtension,
                    learningUnitViewElementId);
            }
        };
        FLGHtmlPaneEditButtonsFactory.FLGLinkEditor linkEditor = new FLGHtmlPaneEditButtonsFactory.FLGLinkEditor() {
            public String linkSelectedToEdit(String htmlAttributeValue) {
                return learningUnitViewManager.editLearningUnitViewElementLink(htmlAttributeValue, learningUnitViewElementId);
            }
        };
        editToolBarComponents = FLGHtmlPaneEditButtonsFactory.createDefaultHtmlPaneEditComponents(fileCreator, linkEditor);
        updateUI();
    }

    protected void buildDependentUI(boolean reloadIfAlreadyLoaded) {
        boolean contentAvailable = false;
        if (learningUnitViewElementsManager != null && learningUnitViewElementId != null) {
            FLGCaseStudyElement learningUnitViewElement =
                (FLGCaseStudyElement)learningUnitViewElementsManager.getLearningUnitViewElement(learningUnitViewElementId, false);
            if (learningUnitViewElement != null) {
                elementTitleHtmlPane.setText("<html><body><h1>" + learningUnitViewElement.getTitle() + "</body></html>");
                if (learningUnitViewElement.getHtmlFileName() != null) {
                    File htmlFile = learningUnitViewElementsManager.resolveRelativeFileName(
                        learningUnitViewElement.getHtmlFileName(), learningUnitViewElement);
                    if (htmlFile.exists()) {
                       elementContentHtmlPane.loadFile(htmlFile, reloadIfAlreadyLoaded);
                    }             
                    else {
                        elementContentHtmlPane.setBase(learningUnitViewElementsManager.resolveRelativeFileName(
                            "dummyFileName", learningUnitViewElement));
                        elementContentHtmlPane.setText("<html><body><p></p></body></html>");
                    }
                } 
                
//                if (learningUnitViewElement.getHtmlFileName() != null)
//                    elementContentHtmlPane.loadFile(learningUnitViewElementsManager.resolveRelativeFileName(learningUnitViewElement.getHtmlFileName(),
//                        learningUnitViewElement), reloadIfAlreadyLoaded);
                else {
                    elementContentHtmlPane.setBase(learningUnitViewElementsManager.resolveRelativeFileName("dummyFileName",
                        learningUnitViewElement));
                    elementContentHtmlPane.setText("<html><body><p></p></body></html>");
                }
                contentAvailable = true;
            }
        }
        if (!contentAvailable) {
            elementTitleHtmlPane.setText("<html><body><p></p></body></html>");
            elementContentHtmlPane.setText("<html><body><p></p></body></html>");
        }
        elementContentHtmlPane.setEditable(editMode && activeLearningUnitViewElementPanel && contentAvailable);
    }

    class FLGCaseStudyElementContentPanel_LearningUnitAdapter extends FSLLearningUnitVetoableAdapter {
        public void learningUnitEditModeChanged(FSLLearningUnitEvent event) {
            if (!event.isEditMode()) {
                elementContentHtmlPane.select(0, 0);
            }
        }
    }


    class FLGCaseStudyElementContentPanel_LearningUnitViewAdapter extends FSLLearningUnitViewVetoableAdapter {
        public void learningUnitViewElementsUserVersionCreated(FSLLearningUnitViewEvent event) {
            if (event.getLearningUnitViewManagerId().equals(learningUnitViewManager.getLearningUnitViewManagerId())) {
                for (int i = 0; i < event.getLearningUnitViewElementIds().length; i++) {
                    if (event.getLearningUnitViewElementIds() [i].equals(learningUnitViewElementId)) {
                        String HtmlFileName = ((FLGCaseStudyElement)learningUnitViewElementsManager.getLearningUnitViewElement(learningUnitViewElementId,
                            false)).getHtmlFileName();
                        if (HtmlFileName != null) {
                            File file = learningUnitViewElementsManager.resolveRelativeFileName(HtmlFileName,
                                learningUnitViewElementsManager.getLearningUnitViewElement(learningUnitViewElementId, false));
                            try {
                                ((HTMLDocument)elementContentHtmlPane.getDocument()).setBase(file.getParentFile().toURL());
                            }
                            catch (Exception e) { System.out.println(e); }
                        }
                    }
                }
            }
        }
    }
}
