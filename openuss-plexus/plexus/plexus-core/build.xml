<project name="openuss :: plexus :: core :: build" default="install" basedir=".">
	<!-- 	In order to get this target under eclipse to work you need to define the variable
			m2_repo which points to your maven2 repository -->
	<target name="clover-view">
		<java fork="true" classname="com.cenqua.clover.reporters.jfc.Viewer">
			<arg line="-i target/clover/clover.db"/>
			<classpath path="${m2_repo}/com/cenqua/clover/clover/1.3.12/clover-1.3.12.jar"/>
		</java>
	</target>
	<target name="compile">
		<exec executable="mvn.bat">
			<arg line="compile" />
		</exec>
	</target>
	<target name="clean">
		<exec executable="mvn.bat">
			<arg line="clean" />
		</exec>
	</target>
	<target name="install">
		<exec executable="mvn.bat">
			<arg line="install" />
		</exec>
	</target>
	<target name="install offline">
		<exec executable="mvn.bat">
			<arg line="-o install" />
		</exec>
	</target>
	<target name="install w/o tests">
		<exec executable="mvn.bat">
			<arg line="install -Dmaven.test.skip=true" />
		</exec>
	</target>	
	<target name="install w/o tests (offline)">
		<exec executable="mvn.bat">
			<arg line="-o install -Dmaven.test.skip=true" />
		</exec>
	</target>	
	<target name="eclipse">
		<exec executable="mvn.bat">
			<arg line="eclipse:clean eclipse:eclipse" />
			<arg line="-DdownloadSources=true" />
		</exec>
	</target>
	
	<target name="hibernate-schema" description="Generates database schema">
		<fileset id="hibernate.mapping.files" dir="target/classes">
			<include name="**/*.hbm.xml" />
		</fileset>
		<pathconvert refid="hibernate.mapping.files" property="hibernate.mappings" pathsep=" " />
		<echo message="mapping files: ${hibernate.mappings}" />
		
		<java classname="org.hibernate.tool.hbm2ddl.SchemaExport" fork="true">
			<arg value="--output=target/firebird_database_schema.sql" />
			<arg value="--create" />
			<arg value="--text" />
			<arg value="--format" />
   			<arg value="--delimiter=;" />
			<arg line="${hibernate.mappings}" />
			<jvmarg value="-Dhibernate.dialect=org.hibernate.dialect.FirebirdDialect" />
			<classpath>
				<pathelement location="${m2_repo}/org/hibernate/hibernate/3.2.2.ga/hibernate-3.2.2.ga.jar"/>
				<pathelement location="${m2_repo}/commons-logging/commons-logging/1.1/commons-logging-1.1.jar"/>
				<pathelement location="${m2_repo}/commons-collections/commons-collections/3.1/commons-collections-3.1.jar"/>
				<pathelement location="${m2_repo}/dom4j/dom4j/1.6.1/dom4j-1.6.1.jar"/>
				<pathelement location="./target/classes" />
				<pathelement location="../plexus-api/target/classes" />
			</classpath>
		</java>
	</target>

	<target name="create-database">
		<taskdef name="createDB" classname="org.openuss.framework.tools.db.DatabaseManager">
			<classpath>
				<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
				<pathelement location="${m2_repo}/ant/ant/1.6.5/ant-1.6.5.jar"/>
				<pathelement location="${m2_repo}/org/openuss/framework/framework-tools/3.0-SNAPSHOT/framework-tools-3.0-SNAPSHOT.jar" />
			</classpath>
		</taskdef>
		<createDB/>
		
		<echo message="INFO: Creating database schemas..." />
		<sql driver="org.firebirdsql.jdbc.FBDriver" url="jdbc:firebirdsql:localhost:openuss30"
			userid="sysdba"
			password="masterkey"
			autocommit="true">
			<classpath>
				<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
			</classpath>
			<transaction src="target/firebird_database_schema.sql"/>
			<transaction src="src/main/data/init.sql"/>
		</sql>		
		<sql driver="org.firebirdsql.jdbc.FBDriver" url="jdbc:firebirdsql:localhost:openuss30-test"
			userid="sysdba"
			password="masterkey"
			autocommit="true">
			<classpath>
				<pathelement location="${m2_repo}/jaybird/jaybird-full/2.1.1/jaybird-full-2.1.1.jar"/>
			</classpath>
			<transaction src="target/firebird_database_schema.sql"/>
			<transaction src="src/main/data/init.sql"/>
		</sql>
		<echo message="INFO: Database schemas created" />
	</target>

</project>